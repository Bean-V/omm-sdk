apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-kapt'
apply plugin: 'maven-publish'

// Fat AAR æ’ä»¶ä¸æ”¯æŒ AGP 8.xï¼Œä½¿ç”¨è‡ªå®šä¹‰ä»»åŠ¡å®ç°

buildscript {
    ext {
        appId = 'com.oort.weichat' // å¥¥é™Œé™Œ - ä¿®å¤ï¼šå®šä¹‰ appId é¿å…åç»­å¼•ç”¨é”™è¯¯
        channel = '@string/app_name' // buglyä¸Šæ˜¾ç¤ºçš„æ¸ é“åï¼Œ

        buglyAppId = '438ff58c22' // buglyé…ç½®çš„appId,
        baiduApiKey = 'Q7wb91P5U7RnKkcwOTu8AQtBpsujKmzu' // baidué…ç½®çš„apiKey,
        googleApiKey = 'AIzaSyAbJjDWUPU6sRsQccNMp8E3soO7YGSkTIg' // googleåœ°å›¾é…ç½®çš„apiKey,
        huaweiAppId = '102058269' // åä¸ºæ¨é€é…ç½®çš„appId,
        xiaomiAppId = '2882303761517581074' // å°ç±³æ¨é€é…ç½®çš„appId,
        xiaomiAppKey = '5951758130074' // å°ç±³æ¨é€é…ç½®çš„appKey,
        meizuAppId = '118639' // é­…æ—æ¨é€é…ç½®çš„appId,
        meizuAppKey = '198cfa2fa66544ba87ab05874ba22868' // é­…æ—æ¨é€é…ç½®çš„appKey,
        vivoAppId = '18094' // VIVOæ¨é€é…ç½®çš„appId,
        vivoAppKey = '41337891-3989-4db0-8894-6ecbf313cefd' // VIVOæ¨é€é…ç½®çš„appKey,
        oppoAppKey = 'dIHycN8J0NsCokwSGss8sskw4' // OPPOæ¨é€é…ç½®çš„appKey,
        oppoAppSecret = 'b9f6927d9eCD0159532dA5c2e1118eC8' // OPPOæ¨é€é…ç½®çš„secret,
        wechatAppId = '' // å¾®ä¿¡ç›¸å…³çš„appId,
        qqAppId = '' // QQç›¸å…³çš„appId,

        buglyAppChannel = channel
        date = new Date().format("yyyyMMdd")
        buglyVersionNameSuffix = '' + '-' + date
    }
}

// åˆ¤æ–­å­˜åœ¨è°·æ­ŒæœåŠ¡é…ç½®æ–‡ä»¶æ‰å¯ç”¨è°·æ­ŒæœåŠ¡ï¼Œ
def googleJson = file('google-services.json')
if (googleJson.exists() && googleJson.readLines().any { it.contains(appId) }) {
    apply plugin: 'com.google.gms.google-services'
    // è°·æ­ŒæœåŠ¡4.2ç‰ˆæœ¬æœ‰å·²çŸ¥bugä¼šå¯¼è‡´å…¶ä»–æ— å…³ä¾èµ–(smack4.3.4)è«åå†²çªï¼Œç¦ç”¨ç›¸å…³æ£€æŸ¥è§£å†³ï¼Œ
    // https://github.com/invertase/react-native-firebase/issues/1676
    //noinspection UnnecessaryQualifiedReference
    com.google.gms.googleservices.GoogleServicesPlugin.config.disableVersionCheck = true
}

android {
    lintOptions {
        abortOnError false
        checkReleaseBuilds false
    }

    packagingOptions {//åŠ ä¸Šè¿™äº›ä»£ç 
        pickFirst 'lib/armeabi-v7a/libijkplayer.so'
        pickFirst 'lib/armeabi-v8a/libijkplayer.so'
        pickFirst 'lib/arm64-v8a/libijkplayer.so'
        pickFirst 'lib/x86/libijkplayer.so'
        pickFirst 'lib/x86_64/libijkplayer.so'

        pickFirst 'lib/armeabi-v7a/libijksdl.so'
        pickFirst 'lib/armeabi-v8a/libijksdl.so'
        pickFirst 'lib/arm64-v8a/libijksdl.so'
        pickFirst 'lib/x86/libijksdl.so'
        pickFirst 'lib/x86_64/libijksdl.so'

        pickFirst 'lib/armeabi-v7a/libijkffmpeg.so'
        pickFirst 'lib/armeabi-v8a/libijkffmpeg.so'
        pickFirst 'lib/arm64-v8a/libijkffmpeg.so'
        pickFirst 'lib/x86/libijkffmpeg.so'
        pickFirst 'lib/x86_64/libijkffmpeg.so'

        pickFirst 'lib/*/libc++_shared.so'

        exclude 'META-INF/LICENSE.txt'
        exclude 'META-INF/NOTICE.txt'

        exclude 'META-INF/*.kotlin_module'
        exclude 'META-INF/rxjava.properties'
    }

    compileSdkVersion compile_version

    namespace "com.oort.weichat"

    defaultConfig {
//        applicationId appId

        buildFeatures {
            buildConfig true
            aidl true
        }

        //ç‰ˆæœ¬å·ï¼Œä¸è¦å‡ºç°4äº†
        versionCode     1013
        versionName "1.0.13" //ç‰ˆæœ¬å·ï¼Œä¸è¦å‡ºç°4äº†
        //ç‰ˆæœ¬å·ï¼Œä¸è¦å‡ºç°4äº†
        minSdkVersion min_version
        targetSdkVersion target_version

        vectorDrawables.useSupportLibrary = true

        ndk {
            abiFilters 'arm64-v8a'
        }

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        multiDexEnabled = true

        buildConfigField('String', "BUGLY_APP_ID", '"' + buglyAppId + '"')
        buildConfigField('String', "BUGLY_APP_CHANNEL", '"' + buglyAppChannel + '"')
        buildConfigField('String', "XIAOMI_APP_ID", '"' + xiaomiAppId + '"')
        buildConfigField('String', "XIAOMI_APP_KEY", '"' + xiaomiAppKey + '"')
        buildConfigField('String', "MEIZU_APP_ID", '"' + meizuAppId + '"')
        buildConfigField('String', "MEIZU_APP_KEY", '"' + meizuAppKey + '"')
        buildConfigField('String', "OPPO_APP_KEY", '"' + oppoAppKey + '"')
        buildConfigField('String', "OPPO_APP_SECRET", '"' + oppoAppSecret + '"')
        buildConfigField('String', "GOOGLE_API_KEY", '"' + googleApiKey + '"')
        buildConfigField('String', "WECHAT_APP_ID", '"' + wechatAppId + '"')
        buildConfigField('String', "QQ_APP_ID", '"' + qqAppId + '"')

        manifestPlaceholders = [
//                APP_ID        : appId,
BAIDU_API_KEY : baiduApiKey,
VIVO_APP_ID   : vivoAppId,
VIVO_APP_KEY  : vivoAppKey,
GOOGLE_API_KEY: googleApiKey,
HUAWEI_APP_ID : huaweiAppId,
QQ_APP_ID     : qqAppId,
        ]

        resConfigs "en", "zh-rCN","ar"
        externalNativeBuild {
            cmake {
                arguments "-DANDROID_SUPPORT_FLEXIBLE_PAGE_SIZES=ON", "-DANDROID_STL=c++_shared"
                cppFlags "-std=c++17"
                cFlags "-DANDROID_PLATFORM=android-26"
            }
        }
    }

    // é«˜ç‰ˆæœ¬asä¸­installReleaseä¸ä¼šä¾èµ–assembleReleaseä¹Ÿå°±ä¸ä¼šå¤åˆ¶apk,
    afterEvaluate {
        // æ²¡é…ç½®ç­¾åçš„è¯ï¼Œå°±æ²¡æœ‰installReleaseï¼Œ
        if (tasks.findByName('installRelease')) {
            installRelease.dependsOn 'assembleRelease'
        }
    }

    dexOptions {
        preDexLibraries = false
        javaMaxHeapSize "4g"
    }

    testOptions {
        unitTests.returnDefaultValues = true
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    useLibrary 'org.apache.http.legacy'

    // ================================================
    // å…³é”®ä¿®æ”¹ï¼šå¼€å¯ R8 ä¼˜åŒ–å¹¶é…ç½®æ‰“åŒ…
    // ================================================
    buildTypes {
        release {
            // å¼€å¯ä»£ç ä¼˜åŒ–
            minifyEnabled true

            // å…³é”®ï¼šå…³é—­èµ„æºå‹ç¼©ï¼Œé¿å… config.xml ç»“æ„è¢«æ”¹
            shrinkResources false

            // æ··æ·†æ–‡ä»¶ä½ç½® - æ·»åŠ åˆå¹¶è§„åˆ™
            proguardFiles getDefaultProguardFile('proguard-android.txt'),
                    'proguard-rules.pro',
                    'proguard-merge-all.pro'

            // ä¸ºæ¶ˆè´¹è€…æä¾›è§„åˆ™
            consumerProguardFiles 'consumer-rules.pro'

            buildConfigField('String', "VERSION_NAME_SUFFIX", '"' + buglyVersionNameSuffix + '"')
        }
        debug {
            minifyEnabled false
            buildConfigField('String', "VERSION_NAME_SUFFIX", '"' + "-DEBUG" + '"')
            debuggable true
        }
    }

    // ç­¾åä¿¡æ¯ä»signing.propertiesä¸­è·å–ï¼Œ
    def signingFile = rootProject.file('signing.properties')
    if (signingFile.exists()) {
        def input = signingFile.newInputStream()
        def p = new Properties()
        p.load(input)
        def jks = rootProject.file(p['storeFile'])
        if (jks.exists()) {
            signingConfigs {
                config {
                    keyAlias p['keyAlias']
                    keyPassword p['keyPassword']
                    storeFile jks
                    storePassword p['storePassword']
                    v1SigningEnabled true
                    v2SigningEnabled true
                }
            }
            buildTypes {
                debug {
                    signingConfig signingConfigs.config
                }
                release {
                    signingConfig signingConfigs.config
                }
            }
        }
    }

    repositories {
        mavenLocal()
        maven {
            url = uri("${System.getProperty('user.home')}/.m2/repository")
        }
        flatDir {
            dirs '../OortWebframeLib/libs'
        }
    }
}

configurations.all {
    resolutionStrategy.eachDependency { details ->
        // jitsiå’Œimagingä¸¤ä¸ªåº“éƒ½ä¾èµ–frescoç‰ˆæœ¬å†²çªäº†ï¼Œ
//        if (details.requested.group == 'com.facebook.fresco') {
//            details.useVersion '2.0.0'
//        }
    }
    // 1.1.0ä¼šå¯¼è‡´å®‰å“5ä¸Šwebviewå´©æºƒï¼Œhttps://stackoverflow.com/a/58131421
    resolutionStrategy.force 'androidx.appcompat:appcompat:1.3.1'
}

// ================================================
// å…³é”®é…ç½®ï¼šåˆ›å»ºåˆå¹¶é…ç½®
// ================================================
configurations {
    // åˆ›å»ºä¸“é—¨ç”¨äºåˆå¹¶çš„é…ç½® - ç®€åŒ–å±æ€§é¿å…å†²çª
    mergedImplementation {
        canBeConsumed = false
        canBeResolved = true
        // ç§»é™¤å¯èƒ½å¯¼è‡´å†²çªçš„å±æ€§ï¼Œè®© Gradle è‡ªåŠ¨è§£æ
    }
    implementation.extendsFrom(mergedImplementation)
}

dependencies {
    // ================================================
    // å°†æ‰€æœ‰ä¾èµ–è¿ç§»åˆ° mergedImplementation
    // ================================================

    // é¡¹ç›®æ¨¡å—
    mergedImplementation project(':oort_imagepick_sdk')
    mergedImplementation project(':ToolsMain')
    mergedImplementation project(':provider_lib')
    mergedImplementation project(':pullToRefershLibraryMy')
    mergedImplementation project(':jcvideoplayer-lib')
    mergedImplementation project(':YZxing-lib')
    mergedImplementation project(':OpenGLlibrary')
    mergedImplementation project(':MPChartLib')
    mergedImplementation project(':liveLibrary')
    mergedImplementation project(':OortWebframeLib')
    mergedImplementation project(':basemodule')
    mergedImplementation project(':AppStore')
    mergedImplementation project(':Contacts')
    mergedImplementation project(':screenrecorder')
    mergedImplementation project(':AIDICert')
    mergedImplementation project(':giraffeplayer')
    mergedImplementation project(':floatview')
    mergedImplementation project(':offline')
    mergedImplementation project(':sound_recon')
    mergedImplementation project(':FrameLibrary')
    mergedImplementation project(':Levc-lib')

    // æ–‡ä»¶ä¾èµ–
    mergedImplementation files('libs/all-20230425.jar')
    mergedImplementation files('../provider_lib/libs/JITLogSupport1.0.0.jar')
    mergedImplementation files('libs/simkeylibrary-release.aar')
    mergedImplementation files('libs/kplayer-androidx-5.0.5-20240704-1.aar')
    mergedImplementation files('libs/alipaySdk-15.5.9-20181123210601.aar')
    mergedImplementation files('libs/xjgarsdklibrary-release-9.2.1-2019-08-31.aar')
    mergedImplementation files('libs/libfriapkrecord-r1.0.1.aar')
    mergedImplementation files('libs/android-async-http-1.4.5.jar')
    mergedImplementation files('libs/BaiduLBS_Android.jar')
    mergedImplementation files('libs/httpmime-4.2.jar')
    mergedImplementation files('libs/nineoldandroids.jar')
    mergedImplementation files('libs/ormlite-android-4.48.jar')
    mergedImplementation files('libs/ormlite-core-4.48.jar')
    mergedImplementation files('libs/universal-image-loader-1.9.0.jar')
    mergedImplementation files('libs/open_sdk_r6199_lite.jar')
    mergedImplementation files('libs/MiPush_SDK_Client_3_6_18.jar')
    mergedImplementation files('libs/vivopushsdk_v2.3.4.jar')
    mergedImplementation files('libs/mcssdk-1.0.1.jar')

    // ç¬¬ä¸‰æ–¹åº“ä¾èµ–
    mergedImplementation 'com.github.bumptech.glide:glide:3.7.0'
    mergedImplementation 'org.greenrobot:eventbus:3.1.1'
    mergedImplementation 'com.tencent.mm.opensdk:wechat-sdk-android-with-mta:1.0.2'
    mergedImplementation 'com.huawei.android.hms:push:2.5.2.300'
    mergedImplementation 'com.huawei.android.hms:base:2.5.2.300'
    mergedImplementation 'com.meizu.flyme.internet:push-internal:3.8.1@aar'
    mergedImplementation 'com.google.firebase:firebase-core:16.0.9'
    mergedImplementation 'com.google.firebase:firebase-messaging:18.0.0'
    mergedImplementation 'com.github.AoEiuV020:jjdxm_ijkplayer:1.1.1'
    mergedImplementation 'com.github.ctiao:DanmakuFlameMaster:0.5.3'
    mergedImplementation 'io.jsonwebtoken:jjwt:0.9.1'
    mergedImplementation 'com.google.android.gms:play-services-maps:16.1.0'
    mergedImplementation 'com.google.android.gms:play-services-location:16.0.0'
    mergedImplementation 'com.squareup.okhttp3:okhttp:3.2.0'
    mergedImplementation 'com.danikula:videocache:2.7.1'
    mergedImplementation 'com.github.yangjie10930:EpMedia:v0.9.5'
    mergedImplementation 'top.zibin:Luban:1.1.3'
    mergedImplementation 'cc.aoeiuv020:imaging:1.0'
    mergedImplementation 'com.hyman:flowlayout-lib:1.1.2'
    mergedImplementation 'me.leolin:ShortcutBadger:1.1.22'
    mergedImplementation 'com.tencent.bugly:crashreport:4.1.9'
    mergedImplementation 'org.jsoup:jsoup:1.10.3'
    mergedImplementation 'com.makeramen:roundedimageview:2.3.0'
    mergedImplementation 'com.scwang.smartrefresh:SmartRefreshLayout:1.1.0-alpha-28'
    mergedImplementation 'org.bouncycastle:bcprov-jdk15on:1.57'
    mergedImplementation 'com.squareup.retrofit2:retrofit:2.4.0'
    mergedImplementation 'com.squareup.retrofit2:converter-gson:2.4.0'
    mergedImplementation 'io.reactivex.rxjava2:rxjava:2.2.3'
    mergedImplementation 'io.reactivex.rxjava2:rxandroid:2.1.0'
    mergedImplementation 'pl.droidsonroids.gif:android-gif-drawable:1.2.28'
    mergedImplementation 'com.joybar.calendar:librarycalendar:1.0.6'
    mergedImplementation 'com.google.android.flexbox:flexbox:3.0.0'
    mergedImplementation 'org.litepal.android:core:1.6.1'
    mergedImplementation 'com.github.xuexiangjys:XUpdate:2.1.4'
    mergedImplementation 'com.github.xuexiangjys:XUI:1.2.1'
    mergedImplementation 'androidx.work:work-runtime:2.7.1'
    mergedImplementation 'com.squareup.okhttp3:logging-interceptor:4.11.0'
    mergedImplementation 'com.contrarywind:Android-PickerView:4.1.7'
    mergedImplementation 'com.jakewharton.threetenabp:threetenabp:1.4.6'
    mergedImplementation "log4j:log4j:1.2.17"
    mergedImplementation "me.imid.swipebacklayout.lib:library:1.1.0"
    mergedImplementation "com.leo618:zip:0.0.1"

    // Smack
    var smackVersion = "4.4.6"
    mergedImplementation "org.igniterealtime.smack:smack-tcp:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-im:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-extensions:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-xmlparser-xpp3:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-experimental:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-android:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-sasl-provided:$smackVersion"
    mergedImplementation "org.igniterealtime.smack:smack-resolver-minidns:$smackVersion"

    // å…¶ä»–å¿…è¦ä¾èµ–ä¿æŒä¸å˜
    implementation 'androidx.room:room-runtime:2.3.0'
    implementation libs.fragment
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'com.google.android.material:material:1.4.0'
    implementation 'androidx.recyclerview:recyclerview:1.0.0'
    implementation 'androidx.gridlayout:gridlayout:1.0.0'
    implementation 'androidx.cardview:cardview:1.0.0'
    implementation 'androidx.multidex:multidex:2.0.1'
    implementation 'com.huangyz0918:androidwm-light:0.1.2'
    implementation libs.react.native
    implementation  (libs.jitsi.meet.sdk)

    kapt "androidx.room:room-compiler:2.3.0"
}

// ================================================
// å…³é”®ï¼šåˆ›å»ºæ··æ·†è§„åˆ™æ–‡ä»¶
// ================================================

// åˆ›å»ºåˆå¹¶æ··æ·†è§„åˆ™æ–‡ä»¶
def createProguardMergeFile() {
    def mergeFile = file('proguard-merge-all.pro')
    if (!mergeFile.exists()) {
        mergeFile.text = """
# ================================================
# åˆå¹¶æ‰€æœ‰ä¾èµ–çš„æ··æ·†è§„åˆ™
# ================================================

# æ ¸å¿ƒä¼˜åŒ–é…ç½®
-optimizationpasses 5
-allowaccessmodification
-overloadaggressively
-mergeinterfacesaggressively

# ä¿æŒæ‰€æœ‰å¿…è¦çš„ç±»

# æ ¸å¿ƒ SDK ç±»
-keep class com.oort.weichat.** { *; }
-keep class com.oort.provider.** { *; }
-keep class com.oort.web.** { *; }
-keep class com.oort.basemodule.** { *; }
-keep class com.oort.tools.** { *; }
-keep class com.oort.image.** { *; }
-keep class com.oort.contacts.** { *; }
-keep class com.oort.store.** { *; }
-keep class com.oort.media.** { *; }
-keep class com.oort.ai.** { *; }

# ç¬¬ä¸‰æ–¹åº“å…³é”®ç±»
-keep class com.tencent.** { *; }
-keep class com.huawei.** { *; }
-keep class com.xiaomi.** { *; }
-keep class com.google.** { *; }
-keep class com.github.bumptech.glide.** { *; }
-keep class org.greenrobot.eventbus.** { *; }
-keep class com.squareup.** { *; }
-keep class io.reactivex.** { *; }
-keep class org.bouncycastle.** { *; }
-keep class com.tencent.bugly.** { *; }
-keep class com.baidu.** { *; }
-keep class org.igniterealtime.smack.** { *; }

# åºåˆ—åŒ–ç±»
-keepclassmembers class * implements java.io.Serializable {
    static final long serialVersionUID;
    private void writeObject(java.io.ObjectOutputStream);
    private void readObject(java.io.ObjectInputStream);
}

# èµ„æºç±»
-keepclassmembers class **.R\$* {
    public static <fields>;
}

# BuildConfig
-keep class **.BuildConfig

# æ³¨è§£
-keepattributes *Annotation*, Signature, InnerClasses

# ç§»é™¤æ—¥å¿—ï¼ˆå‡å°ä½“ç§¯ï¼‰
-assumenosideeffects class android.util.Log {
    public static *** d(...);
    public static *** v(...);
    public static *** i(...);
    public static *** w(...);
    public static *** e(...);
}

# ä¸è¦è­¦å‘Šä»»ä½•ç±»ï¼ˆç¡®ä¿ç¼–è¯‘é€šè¿‡ï¼‰
-dontwarn **
"""
    }
}

// åˆ›å»ºæ¶ˆè´¹è€…è§„åˆ™æ–‡ä»¶
def createConsumerRulesFile() {
    def consumerFile = file('consumer-rules.pro')
    if (!consumerFile.exists()) {
        consumerFile.text = """
# ================================================
# æ¶ˆè´¹è€…æ··æ·†è§„åˆ™
# ================================================

# ä¿æŒ SDK æ‰€æœ‰å…¬å¼€ API
-keep class com.oort.weichat.** {
    public *;
}

# ä¿æŒæ‰€æœ‰æ¥å£
-keep interface com.oort.weichat.** {
    *;
}

# ä¿æŒæ‰€æœ‰æ³¨è§£
-keepattributes *Annotation*

# ä¸è¦è­¦å‘Š SDK å†…éƒ¨ä»£ç 
-dontwarn com.oort.**
-dontwarn com.tencent.**
-dontwarn com.huawei.**
-dontwarn com.google.**
"""
    }
}

// åœ¨é…ç½®é˜¶æ®µåˆ›å»ºè§„åˆ™æ–‡ä»¶
afterEvaluate {
    createProguardMergeFile()
    createConsumerRulesFile()
}

// ================================================
// ä½¿ç”¨ Variant API å®ç°ä¸€ç«™å¼æ‰“åŒ…
// ================================================

import com.android.build.api.artifact.SingleArtifact
import org.gradle.api.DefaultTask
import org.gradle.api.file.DirectoryProperty
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.file.ConfigurableFileCollection
import org.gradle.api.provider.Property
import org.gradle.api.tasks.InputDirectory
import org.gradle.api.tasks.InputFiles
import org.gradle.api.tasks.OutputFile
import org.gradle.api.tasks.TaskAction
import org.gradle.api.attributes.Usage
import org.gradle.api.attributes.Category
import org.gradle.api.artifacts.ProjectDependency
import java.util.jar.JarOutputStream
import java.util.zip.ZipEntry

// è‡ªå®šä¹‰ä»»åŠ¡ï¼šåˆå¹¶æ‰€æœ‰ä¾èµ–åˆ° AAR
abstract class MergeAllDependenciesTask extends DefaultTask {
    
    @InputDirectory
    abstract DirectoryProperty getAarDirectory()
    
    @InputFiles
    abstract ConfigurableFileCollection getDependencyFiles()
    
    @OutputFile
    abstract RegularFileProperty getOutputAar()
    
    @TaskAction
    void mergeAllDependencies() {
        println "ğŸ”„ [Variant API] å¼€å§‹åˆå¹¶æ‰€æœ‰ä¾èµ–..."
        
        // æŸ¥æ‰¾åŸå§‹ AAR
        def aarDir = aarDirectory.get().asFile
        def originalAar = aarDir.listFiles()?.find { it.name.endsWith('.aar') }
        
        if (!originalAar || !originalAar.exists()) {
            println "âŒ åŸå§‹ AAR ä¸å­˜åœ¨äº: ${aarDir.path}"
            return
        }
        
        println "ğŸ“¦ æ‰¾åˆ°åŸå§‹ AAR: ${originalAar.name}"
        
        // åˆ›å»ºä¸´æ—¶ç›®å½•
        def tempDir = new File(project.buildDir, "temp/variant-merge/")
        tempDir.deleteDir()
        tempDir.mkdirs()
        
        // è§£å‹åŸå§‹ AAR
        project.copy {
            from project.zipTree(originalAar)
            into tempDir
        }
        
        // åˆ›å»ºåˆå¹¶çš„ classes ç›®å½•
        def mergedClassesDir = new File(tempDir, "merged-classes/")
        mergedClassesDir.mkdirs()
        
        // å…ˆå¤åˆ¶åŸå§‹çš„ classes.jar å†…å®¹
        def originalClassesJar = new File(tempDir, "classes.jar")
        if (originalClassesJar.exists()) {
            project.copy {
                from project.zipTree(originalClassesJar)
                include '**/*.class'
                into mergedClassesDir
            }
            println "  âœ… æå–åŸå§‹ classes.jar"
        }
        
        // æ”¶é›†æ‰€æœ‰ä¾èµ–çš„ç±»æ–‡ä»¶
        def dependencyCount = 0
        def depFiles = dependencyFiles.files
        
        depFiles.each { file ->
            if (file.exists()) {
                dependencyCount++
                
                if (file.name.endsWith('.jar')) {
                    // åˆå¹¶ JAR æ–‡ä»¶
                    try {
                        project.copy {
                            from project.zipTree(file)
                            include '**/*.class'
                            exclude 'META-INF/**'
                            exclude 'module-info.class'
                            into mergedClassesDir
                            duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                        }
                        println "  âœ… åˆå¹¶ JAR: ${file.name}"
                    } catch (Exception e) {
                        println "  âš ï¸  è·³è¿‡ JAR: ${file.name} - ${e.message}"
                    }
                    
                } else if (file.name.endsWith('.aar')) {
                    // åˆå¹¶ AAR ä¸­çš„ classes.jar
                    try {
                        def tempAarDir = new File(tempDir, "temp-aar-${file.name.replace('.aar', '')}/")
                        tempAarDir.mkdirs()
                        
                        project.copy {
                            from project.zipTree(file)
                            include 'classes.jar'
                            into tempAarDir
                        }
                        
                        def classesJar = new File(tempAarDir, "classes.jar")
                        if (classesJar.exists()) {
                            project.copy {
                                from project.zipTree(classesJar)
                                include '**/*.class'
                                exclude 'META-INF/**'
                                exclude 'module-info.class'
                                into mergedClassesDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                            println "  âœ… åˆå¹¶ AAR: ${file.name}"
                        }
                        
                        tempAarDir.deleteDir()
                    } catch (Exception e) {
                        println "  âš ï¸  è·³è¿‡ AAR: ${file.name} - ${e.message}"
                    }
                }
            }
        }
        
        println "ğŸ“Š å…±å¤„ç† ${dependencyCount} ä¸ªä¾èµ–æ–‡ä»¶"
        
        // åˆ›å»ºæ–°çš„ classes.jar
        if (mergedClassesDir.listFiles()?.size() > 0) {
            println "ğŸ“¦ åˆ›å»ºåˆå¹¶çš„ classes.jar..."
            
            def mergedJarFile = new File(tempDir, "classes-merged.jar")
            def jarOutput = new JarOutputStream(new FileOutputStream(mergedJarFile))
            
            // æ”¶é›†æ‰€æœ‰ class æ–‡ä»¶
            def classFiles = []
            mergedClassesDir.eachFileRecurse { file ->
                if (file.isFile() && file.name.endsWith('.class')) {
                    classFiles << file
                }
            }
            
            // å†™å…¥ JAR
            classFiles.each { file ->
                def entryName = mergedClassesDir.toURI().relativize(file.toURI()).toString()
                jarOutput.putNextEntry(new ZipEntry(entryName))
                jarOutput.write(file.bytes)
                jarOutput.closeEntry()
            }
            jarOutput.close()
            
            // æ›¿æ¢åŸå§‹çš„ classes.jar
            if (originalClassesJar.exists()) {
                originalClassesJar.delete()
            }
            mergedJarFile.renameTo(originalClassesJar)
            
            println "âœ… ç±»æ–‡ä»¶åˆå¹¶å®Œæˆ (${classFiles.size()} ä¸ªç±»)"
        }
        
        // æ¸…ç†ä¸´æ—¶ç›®å½•
        mergedClassesDir.deleteDir()
        new File(tempDir, "temp-aar/").deleteDir()
        
        // é‡æ–°æ‰“åŒ…ä¸º AAR
        def outputFile = outputAar.get().asFile
        outputFile.parentFile.mkdirs()
        
        project.ant.zip(destfile: outputFile) {
            fileset(dir: tempDir) {
                include(name: "**/*")
                exclude(name: "merged-classes/**")
                exclude(name: "temp-aar*/**")
            }
        }
        
        println """
ğŸ‰ [Variant API] ä¸€ç«™å¼æ‰“åŒ…å®Œæˆï¼
ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
  - åŸå§‹ AAR: ${String.format("%.2f", originalAar.size() / 1024 / 1024)} MB
  - åˆå¹¶å AAR: ${String.format("%.2f", outputFile.size() / 1024 / 1024)} MB
  - å¤„ç†ä¾èµ–æ•°: ${dependencyCount}
ğŸ“ è¾“å‡ºæ–‡ä»¶: ${outputFile.path}
        """
    }
}

// ================================================
// ä½¿ç”¨ Variant API æ³¨å†Œä»»åŠ¡
// ================================================

androidComponents {
    onVariants(selector().withBuildType("release")) { variant ->
        
        // æ³¨å†Œåˆå¹¶ä¾èµ–ä»»åŠ¡
        def mergeTask = project.tasks.register(
            "merge${variant.name.capitalize()}Dependencies",
            MergeAllDependenciesTask.class
        ) { task ->
            // è¾“å…¥ï¼šåŸå§‹ AAR ç›®å½• - ä½¿ç”¨ bundleReleaseAar ä»»åŠ¡çš„è¾“å‡ºç›®å½•
            task.aarDirectory.set(
                project.layout.buildDirectory.dir("outputs/aar")
            )
            
            // ä¾èµ– bundleReleaseAar ä»»åŠ¡
            task.dependsOn("bundle${variant.name.capitalize()}Aar")
            
            println "ğŸ”§ [é…ç½®é˜¶æ®µ] æ­£åœ¨é…ç½®åˆå¹¶ä»»åŠ¡..."
            
            // ç¡®ä¿æ‰€æœ‰é¡¹ç›®ä¾èµ–çš„ AAR éƒ½å·²æ„å»º
            def projectDeps = []
            project.configurations.mergedImplementation.dependencies.each { dep ->
                if (dep instanceof ProjectDependency) {
                    def depProject = dep.dependencyProject
                    projectDeps << depProject.name
                    
                    // ä¾èµ–æ¯ä¸ªé¡¹ç›®çš„ bundle ä»»åŠ¡
                    def bundleTaskName = "bundle${variant.name.capitalize()}Aar"
                    try {
                        def depBundleTask = depProject.tasks.findByName(bundleTaskName)
                        if (depBundleTask) {
                            task.dependsOn(depBundleTask)
                            println "  âœ… æ·»åŠ ä¾èµ–: ${depProject.name}:${bundleTaskName}"
                        } else {
                            println "  âš ï¸  æœªæ‰¾åˆ°ä»»åŠ¡: ${depProject.name}:${bundleTaskName}"
                        }
                    } catch (Exception e) {
                        println "  âš ï¸  é…ç½®ä¾èµ–å¤±è´¥: ${depProject.name} - ${e.message}"
                    }
                }
            }
            
            println "ğŸ“¦ é¡¹ç›®ä¾èµ–æ€»æ•°: ${projectDeps.size()}"
            
            // è¾“å…¥ï¼šä¾èµ–æ–‡ä»¶é›†åˆ - åœ¨æ‰§è¡Œé˜¶æ®µåŠ¨æ€æ”¶é›†
            task.dependencyFiles.from(
                project.provider {
                    println "\nğŸ” [æ‰§è¡Œé˜¶æ®µ] å¼€å§‹æ”¶é›†ä¾èµ–æ–‡ä»¶..."
                    def files = []
                    def projectAars = []
                    def externalJars = []
                    def externalAars = []
                    
                    // 1. æ”¶é›†é¡¹ç›®ä¾èµ–çš„ AAR
                    println "ğŸ“¦ æ”¶é›†é¡¹ç›®ä¾èµ–çš„ AAR..."
                    project.configurations.mergedImplementation.dependencies.each { dep ->
                        if (dep instanceof ProjectDependency) {
                            def depProject = dep.dependencyProject
                            def aarDir = new File(depProject.buildDir, "outputs/aar")
                            
                            if (aarDir.exists()) {
                                def found = false
                                aarDir.listFiles()?.each { file ->
                                    if (file.name.endsWith('.aar') && file.name.contains('release')) {
                                        files << file
                                        projectAars << file.name
                                        found = true
                                        println "  âœ… ${depProject.name}: ${file.name} (${String.format("%.2f", file.size() / 1024 / 1024)} MB)"
                                    }
                                }
                                if (!found) {
                                    println "  âš ï¸  ${depProject.name}: æœªæ‰¾åˆ° release AAR åœ¨ ${aarDir.path}"
                                }
                            } else {
                                println "  âŒ ${depProject.name}: AAR ç›®å½•ä¸å­˜åœ¨ ${aarDir.path}"
                            }
                        }
                    }
                    
                    // 2. æ”¶é›†å¤–éƒ¨ä¾èµ–å’Œæ–‡ä»¶ä¾èµ–
                    println "\nğŸ“š æ”¶é›†å¤–éƒ¨ä¾èµ–..."
                    try {
                        def resolvedArtifacts = project.configurations.mergedImplementation.resolvedConfiguration.resolvedArtifacts
                        println "  è§£æåˆ° ${resolvedArtifacts.size()} ä¸ªä¾èµ–"
                        
                        resolvedArtifacts.each { artifact ->
                            def file = artifact.file
                            
                            // åªæ”¶é›†å¤–éƒ¨ä¾èµ–ï¼ˆéé¡¹ç›®ä¾èµ–ï¼‰
                            if (file.exists()) {
                                // æ’é™¤å·²ç»æ”¶é›†çš„é¡¹ç›® AAR
                                def isProjectAar = projectAars.any { it == file.name }
                                
                                if (!isProjectAar) {
                                    if (file.name.endsWith('.jar')) {
                                        files << file
                                        externalJars << file.name
                                        println "  âœ… JAR: ${file.name}"
                                    } else if (file.name.endsWith('.aar')) {
                                        files << file
                                        externalAars << file.name
                                        println "  âœ… AAR: ${file.name}"
                                    }
                                }
                            } else {
                                println "  âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: ${file.path}"
                            }
                        }
                    } catch (Exception e) {
                        println "  âŒ è§£æå¤–éƒ¨ä¾èµ–æ—¶å‡ºé”™: ${e.message}"
                        e.printStackTrace()
                    }
                    
                    println "\nğŸ“Š ä¾èµ–æ”¶é›†ç»Ÿè®¡:"
                    println "  - é¡¹ç›® AAR: ${projectAars.size()}"
                    println "  - å¤–éƒ¨ AAR: ${externalAars.size()}"
                    println "  - å¤–éƒ¨ JAR: ${externalJars.size()}"
                    println "  - æ€»è®¡: ${files.size()} ä¸ªæ–‡ä»¶"
                    
                    if (files.isEmpty()) {
                        println "\nâš ï¸  è­¦å‘Š: æœªæ”¶é›†åˆ°ä»»ä½•ä¾èµ–æ–‡ä»¶ï¼"
                    }
                    
                    return files
                }
            )
            
            // è¾“å‡ºï¼šåˆå¹¶åçš„ AAR
            task.outputAar.set(
                new File(project.buildDir, "outputs/aar/${variant.name}-complete.aar")
            )
            
            task.group = 'build'
            task.description = "åˆå¹¶ ${variant.name} çš„æ‰€æœ‰ä¾èµ–åˆ°å•ä¸ª AAR"
        }
        
        println "âœ… å·²æ³¨å†Œä»»åŠ¡: merge${variant.name.capitalize()}Dependencies"
    }
}

// ================================================
// åˆ›å»ºå‘å¸ƒåŒ…ä»»åŠ¡
// ================================================

task createCompleteSdkPackage {
    dependsOn 'mergeReleaseDependencies'
    
    doLast {
        def sourceAar = file("$buildDir/outputs/aar/release-complete.aar")
        
        if (!sourceAar.exists()) {
            println "âŒ æ‰¾ä¸åˆ°åˆå¹¶åçš„ AAR: ${sourceAar.path}"
            return
        }
        
        def publishDir = file("$buildDir/publish/")
        publishDir.mkdirs()
        
        // å¤åˆ¶åˆ°å‘å¸ƒç›®å½•
        copy {
            from sourceAar
            into publishDir
            rename { 'wechat-sdk-complete.aar' }
        }
        
        // ç”Ÿæˆä½¿ç”¨è¯´æ˜
        def readmeFile = file("$publishDir/README.md")
        readmeFile.text = """# å¥¥é™Œé™Œå¾®ä¿¡ SDK å®Œæ•´ç‰ˆ

## ç‰ˆæœ¬ä¿¡æ¯
- ç‰ˆæœ¬å·: ${android.defaultConfig.versionName}
- æ„å»ºæ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
- æ‰“åŒ…æ–¹å¼: Variant API + R8 ä¼˜åŒ– + ä¾èµ–åˆå¹¶

## ç‰¹ç‚¹
- å•ä¸€ AAR æ–‡ä»¶ - åŒ…å«æ‰€æœ‰ä»£ç ã€èµ„æºå’Œä¾èµ–
- æ— éœ€å…¶ä»–é…ç½® - ç¬¬ä¸‰æ–¹åªéœ€è¿™ä¸€è¡Œä¾èµ–
- R8 ä¼˜åŒ– - è‡ªåŠ¨ç§»é™¤æœªä½¿ç”¨ä»£ç 
- å®Œæ•´åŠŸèƒ½ - æ‰€æœ‰æ¨¡å—åŠŸèƒ½éƒ½å¯ç”¨
- Variant API - ä½¿ç”¨æœ€æ–°çš„ Gradle æ„å»º API

## ä½¿ç”¨æ–¹æ³•

### ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶æ–‡ä»¶
å°† wechat-sdk-complete.aar å¤åˆ¶åˆ°é¡¹ç›®çš„ libs ç›®å½•

### ç¬¬äºŒæ­¥ï¼šé…ç½®ä¾èµ–
åœ¨ app/buildxxx.gradle ä¸­æ·»åŠ ï¼š

```gradle
repositories {
    flatDir {
        dirs 'libs'
    }
}

dependencies {
    // åªéœ€è¦è¿™ä¸€è¡Œï¼
    implementation(name: 'wechat-sdk-complete', ext: 'aar')
}
```

### ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ä»£ç 

```kotlin
// åˆå§‹åŒ–
WeChatSdk.init(context)

// ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
val contacts = WeChatSdk.getContacts()
WeChatSdk.startVideoCall("user123")
WeChatSdk.payWithWeChat("order123")
// æ‰€æœ‰åŠŸèƒ½éƒ½å¯ç”¨ï¼
```

## åŒ…å«æ¨¡å—
${configurations.mergedImplementation.dependencies.findAll { it instanceof ProjectDependency }.collect { "- ${it.name}" }.join('\n')}

## æŠ€æœ¯æ”¯æŒ
- å®˜ç½‘: https://www.oortcloud.com
- æ”¯æŒ: support@oortcloud.com

## æ„å»ºä¿¡æ¯
- ä½¿ç”¨ Variant API æ„å»º
- è‡ªåŠ¨åˆå¹¶æ‰€æœ‰ä¾èµ–
- R8 ä»£ç ä¼˜åŒ–å’Œæ··æ·†
"""
        
        println """
[Variant API] å‘å¸ƒåŒ…å·²ç”Ÿæˆï¼
ä½ç½®: $publishDir

åŒ…å«:
- wechat-sdk-complete.aar (å®Œæ•´SDK - ${String.format("%.2f", sourceAar.size() / 1024 / 1024)} MB)
- README.md (ä½¿ç”¨è¯´æ˜)

ç¬¬ä¸‰æ–¹ä½¿ç”¨åªéœ€:
1. å¤åˆ¶ wechat-sdk-complete.aar åˆ° libs ç›®å½•
2. æ·»åŠ ä¸€è¡Œä¾èµ–: implementation(name: 'wechat-sdk-complete', ext: 'aar')
3. æ— éœ€ä»»ä½•å…¶ä»–é…ç½®
        """
    }
}

// ä¸€é”®æ„å»ºä»»åŠ¡
task buildAllInOne {
    group = 'build'
    description = 'ä¸€é”®æ„å»ºå®Œæ•´çš„ SDK å‘å¸ƒåŒ…'
    
    dependsOn 'clean', 'assembleRelease', 'createCompleteSdkPackage'
    
    doLast {
        println """
[Variant API] ä¸€ç«™å¼æ‰“åŒ…å®Œæˆï¼
è¾“å‡ºç›®å½•: $buildDir/publish/

æŸ¥çœ‹ç»“æœ:
  Windows: dir $buildDir\\publish
  Linux/Mac: ls -la $buildDir/publish/
        """
    }
}

// ç¡®ä¿ä»»åŠ¡æ‰§è¡Œé¡ºåº
afterEvaluate {
    def assembleTask = tasks.findByName('assembleRelease')
    def createTask = tasks.findByName('createCompleteSdkPackage')
    
    if (assembleTask) {
        assembleTask.mustRunAfter 'clean'
    }
    if (createTask && assembleTask) {
        createTask.mustRunAfter assembleTask
    }
}

// ================================================
// å‘å¸ƒåˆ° Maven
// ================================================

afterEvaluate {
    publishing {
        publications {
            complete(MavenPublication) {
                groupId = 'com.oortcloud'
                artifactId = 'wechat-sdk-complete'
                version = android.defaultConfig.versionName

                // ä½¿ç”¨ Variant API ç”Ÿæˆçš„åˆå¹¶åçš„ AAR
                artifact(file("$buildDir/outputs/aar/release-complete.aar")) {
                    builtBy tasks.named('mergeReleaseDependencies')
                }

                pom {
                    name = 'å¥¥é™Œé™Œå¾®ä¿¡ SDK å®Œæ•´ç‰ˆ'
                    description = 'ä¸€ç«™å¼å¾®ä¿¡è§£å†³æ–¹æ¡ˆ SDKï¼Œä½¿ç”¨ Variant API æ„å»ºï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½å’Œä¾èµ–'
                    url = 'https://www.oortcloud.com'

                    licenses {
                        license {
                            name = 'Apache License 2.0'
                            url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                        }
                    }

                    developers {
                        developer {
                            id = 'oortcloud'
                            name = 'å¥¥é™Œé™Œå›¢é˜Ÿ'
                            email = 'dev@oortcloud.com'
                        }
                    }
                }
            }
        }

        repositories {
            maven {
                name = 'local'
                url = uri("${buildDir}/repo")
            }
            
            // å¯é€‰ï¼šå‘å¸ƒåˆ° Maven Central
            // maven {
            //     name = 'sonatype'
            //     url = version.endsWith('SNAPSHOT') 
            //         ? 'https://oss.sonatype.org/content/repositories/snapshots/'
            //         : 'https://oss.sonatype.org/service/local/staging/deploy/maven2/'
            //     credentials {
            //         username = project.findProperty('ossrhUsername') ?: ''
            //         password = project.findProperty('ossrhPassword') ?: ''
            //     }
            // }
        }
    }
}

// ================================================
// é…ç½®ä¾èµ–æ’é™¤
// ================================================

configurations {
    all*.exclude group: 'xpp3', module: 'xpp3'
}

// ================================================
// æ„å»ºè„šæœ¬
// ================================================

// åˆ›å»ºæ„å»ºè„šæœ¬æ–‡ä»¶
task createBuildScript {
    doLast {
        def scriptFile = file("$buildDir/build-allinone.sh")
        scriptFile.text = """#!/bin/bash
# å¥¥é™Œé™Œå¾®ä¿¡ SDK ä¸€ç«™å¼æ‰“åŒ…è„šæœ¬

echo "ğŸš€ å¼€å§‹æ„å»ºå¥¥é™Œé™Œå¾®ä¿¡ SDK å®Œæ•´ç‰ˆ..."

# æ¸…ç†
./gradlew clean

echo "ğŸ”§ ç¼–è¯‘ä¸»æ¨¡å—..."
./gradlew assembleRelease

echo "ğŸ”„ åˆå¹¶æ‰€æœ‰ä¾èµ–..."
./gradlew mergeAllDependencies

echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
./gradlew createCompleteSdkPackage

echo ""
echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
echo ""
echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶:"
echo "   $buildDir/publish/wechat-sdk-complete.aar"
echo "   $buildDir/publish/README.md"
echo ""
echo "ğŸ“‹ ç¬¬ä¸‰æ–¹ä½¿ç”¨:"
echo "   1. å¤åˆ¶ wechat-sdk-complete.aar åˆ° libs ç›®å½•"
echo "   2. æ·»åŠ ä¸€è¡Œä¾èµ–"
echo "   3. æ— éœ€ä»»ä½•å…¶ä»–é…ç½®"
"""
        scriptFile.setExecutable(true)

        println "ğŸ“œ æ„å»ºè„šæœ¬å·²åˆ›å»º: ${scriptFile.path}"
        println "è¿è¡Œ: ./${scriptFile.name}"
    }
}