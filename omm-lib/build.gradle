apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-kapt'
apply plugin: 'maven-publish'

buildscript {
    ext {

//        appId = 'com.oortcloud.rjt' // å¥¥é™Œé™Œ//ommOA01
        channel = '@string/app_name' // buglyä¸Šæ˜¾ç¤ºçš„æ¸ é“åï¼Œ

        buglyAppId = '438ff58c22' // buglyé…ç½®çš„appId,
        baiduApiKey = 'Q7wb91P5U7RnKkcwOTu8AQtBpsujKmzu' // baidué…ç½®çš„apiKey,
        googleApiKey = 'AIzaSyAbJjDWUPU6sRsQccNMp8E3soO7YGSkTIg' // googleåœ°å›¾é…ç½®çš„apiKey,
        huaweiAppId = '102058269' // åŽä¸ºæŽ¨é€é…ç½®çš„appId,
        xiaomiAppId = '2882303761517581074' // å°ç±³æŽ¨é€é…ç½®çš„appId,
        xiaomiAppKey = '5951758130074' // å°ç±³æŽ¨é€é…ç½®çš„appKey,
        meizuAppId = '118639' // é­…æ—æŽ¨é€é…ç½®çš„appId,
        meizuAppKey = '198cfa2fa66544ba87ab05874ba22868' // é­…æ—æŽ¨é€é…ç½®çš„appKey,
        vivoAppId = '18094' // VIVOæŽ¨é€é…ç½®çš„appId,
        vivoAppKey = '41337891-3989-4db0-8894-6ecbf313cefd' // VIVOæŽ¨é€é…ç½®çš„appKey,
        oppoAppKey = 'dIHycN8J0NsCokwSGss8sskw4' // OPPOæŽ¨é€é…ç½®çš„appKey,
        oppoAppSecret = 'b9f6927d9eCD0159532dA5c2e1118eC8' // OPPOæŽ¨é€é…ç½®çš„secret,
        wechatAppId = '' // å¾®ä¿¡ç›¸å…³çš„appId,
        qqAppId = '' // QQç›¸å…³çš„appId,

        buglyAppChannel = channel
        date = new Date().format("yyyyMMdd")
        buglyVersionNameSuffix = '' + '-' + date
    }
}
// åˆ¤æ–­å­˜åœ¨è°·æ­ŒæœåŠ¡é…ç½®æ–‡ä»¶æ‰å¯ç”¨è°·æ­ŒæœåŠ¡ï¼Œ
def googleJson = file('google-services.json')
if (googleJson.exists() && googleJson.readLines().any { it.contains(appId) }) {
    apply plugin: 'com.google.gms.google-services'
    // è°·æ­ŒæœåŠ¡4.2ç‰ˆæœ¬æœ‰å·²çŸ¥bugä¼šå¯¼è‡´å…¶ä»–æ— å…³ä¾èµ–(smack4.3.4)èŽ«åå†²çªï¼Œç¦ç”¨ç›¸å…³æ£€æŸ¥è§£å†³ï¼Œ
    // https://github.com/invertase/react-native-firebase/issues/1676
    //noinspection UnnecessaryQualifiedReference
    com.google.gms.googleservices.GoogleServicesPlugin.config.disableVersionCheck = true
}
android {
    lintOptions {
        abortOnError false
        checkReleaseBuilds false
    }

    packagingOptions {//åŠ ä¸Šè¿™äº›ä»£ç 
        pickFirst 'lib/armeabi-v7a/libijkplayer.so'
        pickFirst 'lib/armeabi-v8a/libijkplayer.so'
        pickFirst 'lib/arm64-v8a/libijkplayer.so'
        pickFirst 'lib/x86/libijkplayer.so'
        pickFirst 'lib/x86_64/libijkplayer.so'

        pickFirst 'lib/armeabi-v7a/libijksdl.so'
        pickFirst 'lib/armeabi-v8a/libijksdl.so'
        pickFirst 'lib/arm64-v8a/libijksdl.so'
        pickFirst 'lib/x86/libijksdl.so'
        pickFirst 'lib/x86_64/libijksdl.so'

        pickFirst 'lib/armeabi-v7a/libijkffmpeg.so'
        pickFirst 'lib/armeabi-v8a/libijkffmpeg.so'
        pickFirst 'lib/arm64-v8a/libijkffmpeg.so'
        pickFirst 'lib/x86/libijkffmpeg.so'
        pickFirst 'lib/x86_64/libijkffmpeg.so'

        pickFirst 'lib/*/libc++_shared.so'

        exclude 'META-INF/LICENSE.txt'
        exclude 'META-INF/NOTICE.txt'

        exclude 'META-INF/*.kotlin_module'
        exclude 'META-INF/rxjava.properties'
    }

    compileSdkVersion compile_version

    namespace "com.oort.weichat"

    defaultConfig {
//        applicationId appId


        buildFeatures {
            buildConfig true
            aidl true
        }
        //ç‰ˆæœ¬å·ï¼Œä¸è¦å‡ºçŽ°4äº†
        versionCode     1013
        versionName "1.0.13" //ç‰ˆæœ¬å·ï¼Œä¸è¦å‡ºçŽ°4äº†
        //ç‰ˆæœ¬å·ï¼Œä¸è¦å‡ºçŽ°4äº†
        minSdkVersion min_version
        targetSdkVersion target_version

        vectorDrawables.useSupportLibrary = true

        ndk {

            abiFilters 'arm64-v8a'
            //abiFilters  "armeabi",//"armeabi-v7a" //,"x86_64"
//             abiFilters "armeabi", "armeabi-v7a", "arm64-v8a", "x86", "x86_64"

        }

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        multiDexEnabled = true
        buildConfigField('String', "BUGLY_APP_ID", '"' + buglyAppId + '"')
        buildConfigField('String', "BUGLY_APP_CHANNEL", '"' + buglyAppChannel + '"')
        buildConfigField('String', "XIAOMI_APP_ID", '"' + xiaomiAppId + '"')
        buildConfigField('String', "XIAOMI_APP_KEY", '"' + xiaomiAppKey + '"')
        buildConfigField('String', "MEIZU_APP_ID", '"' + meizuAppId + '"')
        buildConfigField('String', "MEIZU_APP_KEY", '"' + meizuAppKey + '"')
        buildConfigField('String', "OPPO_APP_KEY", '"' + oppoAppKey + '"')
        buildConfigField('String', "OPPO_APP_SECRET", '"' + oppoAppSecret + '"')
        buildConfigField('String', "GOOGLE_API_KEY", '"' + googleApiKey + '"')
        buildConfigField('String', "WECHAT_APP_ID", '"' + wechatAppId + '"')
        buildConfigField('String', "QQ_APP_ID", '"' + qqAppId + '"')
        manifestPlaceholders = [
//                APP_ID        : appId,
            BAIDU_API_KEY : baiduApiKey,
            VIVO_APP_ID   : vivoAppId,
            VIVO_APP_KEY  : vivoAppKey,
            GOOGLE_API_KEY: googleApiKey,
            HUAWEI_APP_ID : huaweiAppId,
            QQ_APP_ID     : qqAppId,
        ]

        resConfigs "en", "zh-rCN","ar"
        externalNativeBuild {
            cmake {
                arguments "-DANDROID_SUPPORT_FLEXIBLE_PAGE_SIZES=ON", "-DANDROID_STL=c++_shared"
                cppFlags "-std=c++17"
                cFlags "-DANDROID_PLATFORM=android-26"
            }
        }
    }

    // é«˜ç‰ˆæœ¬asä¸­installReleaseä¸ä¼šä¾èµ–assembleReleaseä¹Ÿå°±ä¸ä¼šå¤åˆ¶apk,
    afterEvaluate {
        // æ²¡é…ç½®ç­¾åçš„è¯ï¼Œå°±æ²¡æœ‰installReleaseï¼Œ
        if (tasks.findByName('installRelease')) {
            installRelease.dependsOn 'assembleRelease'
        }
    }
    // multiDexçš„ä¸€äº›ç›¸å…³é…ç½®ï¼Œè¿™æ ·é…ç½®å¯ä»¥è®©ä½ çš„ç¼–è¯‘é€Ÿåº¦æ›´å¿«
    dexOptions {
        // è®©å®ƒä¸è¦å¯¹LibåšpreDexing
        preDexLibraries = false
        // å¼€å¯incremental dexing,ä¼˜åŒ–ç¼–è¯‘æ•ˆçŽ‡ï¼Œè¿™ä¸ªåŠŸèƒ½android studioé»˜è®¤æ˜¯å…³é—­çš„
        // incremental true
        // å¢žåŠ javaå †å†…å­˜å¤§å°
        javaMaxHeapSize "4g"
    }

    // å•å…ƒæµ‹è¯•ç”¨ï¼Œ
    testOptions {
        unitTests.returnDefaultValues = true
    }

    // è¿›è¡ŒJAVA çš„ç‰ˆæœ¬é…ç½®ï¼Œä½¿ç”¨å¯¹åº”ç‰ˆæœ¬çš„ä¸€äº›æ–°ç‰¹æ€§
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    useLibrary 'org.apache.http.legacy'



    buildTypes {
        release {
            minifyEnabled false

            //  minifyEnabled true // å¯ä¿ç•™æ··æ·†ï¼Œä½†éœ€é…åˆä¸Šè¿° ProGuard è§„åˆ™
            shrinkResources false // å…³é”®ï¼šå…³é—­èµ„æºåŽ‹ç¼©ï¼Œé¿å… config.xml ç»“æž„è¢«æ”¹
            // æ··æ·†æ–‡ä»¶ä½ç½®
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            buildConfigField('String', "VERSION_NAME_SUFFIX", '"' + buglyVersionNameSuffix + '"')
        }
        debug {
            buildConfigField('String', "VERSION_NAME_SUFFIX", '"' + "-DEBUG" + '"')
            debuggable true
        }
    }

    // ç­¾åä¿¡æ¯ä»Žsigning.propertiesä¸­èŽ·å–ï¼Œ
    // debugå’Œreleaseä½¿ç”¨ç›¸åŒç­¾åï¼Œä»¥ä¾¿ç”¨debugåŒ…è¦†ç›–releaseåŒ…ä»Žè€Œè°ƒè¯•ï¼Œ
    // å¦‚æžœæ²¡æœ‰ï¼Œå°±ä¼šä½¿ç”¨é»˜è®¤debugç­¾åï¼Œ
    def signingFile = rootProject.file('signing.properties')
    if (signingFile.exists()) {
        def input = signingFile.newInputStream()
        def p = new Properties()
        p.load(input)
        // ç­¾åæ–‡ä»¶å­˜åœ¨æ‰é…ç½®ç­¾åï¼Œ
        def jks = rootProject.file(p['storeFile'])
        if (jks.exists()) {
            signingConfigs {
                config {
                    keyAlias p['keyAlias']
                    keyPassword p['keyPassword']
                    storeFile jks
                    storePassword p['storePassword']
                    v1SigningEnabled true
                    v2SigningEnabled true
                }
            }
            buildTypes {
                debug {
                    signingConfig signingConfigs.config
                }
                release {
                    signingConfig signingConfigs.config
                }
            }
        }
    }
    repositories {
        mavenLocal()  // â† è¿™è¡Œå¾ˆé‡è¦ï¼
        // ä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šæœ¬åœ°ä»“åº“è·¯å¾„
        maven {
            url = uri("${System.getProperty('user.home')}/.m2/repository")
        }
//
//        flatDir {
//            dirs '../OortWebframeLib/libs'   // aarç›®å½•
//        }


    }
}

configurations.all {
    resolutionStrategy.eachDependency { details ->
        // jitsiå’Œimagingä¸¤ä¸ªåº“éƒ½ä¾èµ–frescoç‰ˆæœ¬å†²çªäº†ï¼Œ
//        if (details.requested.group == 'com.facebook.fresco') {
//            details.useVersion '2.0.0'
//        }
    }
    // 1.1.0ä¼šå¯¼è‡´å®‰å“5ä¸Šwebviewå´©æºƒï¼Œhttps://stackoverflow.com/a/58131421
    // å‡†ç¡®è¯´æ˜¯ä½Žç‰ˆæœ¬webViewçš„bugï¼Œæ™®éå­˜åœ¨å›½äº§å®‰å“5ä¸Šï¼Œ
    resolutionStrategy.force 'androidx.appcompat:appcompat:1.3.1'
}

configurations.maybeCreate("publishAar")

// åœ¨æ–‡ä»¶é¡¶éƒ¨å®šä¹‰å˜é‡
// JitPack æž„å»ºæ—¶ä¹Ÿåº”è¯¥ä½¿ç”¨æœ¬åœ°é¡¹ç›®ä¾èµ–ï¼Œå› ä¸ºæ‰€æœ‰æ¨¡å—éƒ½åœ¨åŒä¸€ä¸ªä»“åº“ä¸­
def isLocalBuild = true  // å§‹ç»ˆä½¿ç”¨æœ¬åœ°é¡¹ç›®ä¾èµ–
dependencies {
    // ========== AndroidX æ ¸å¿ƒåº“ ==========
    implementation 'androidx.appcompat:appcompat:1.3.1'
    implementation 'com.google.android.material:material:1.4.0'
    implementation 'androidx.recyclerview:recyclerview:1.2.1'
    implementation 'androidx.gridlayout:gridlayout:1.0.0'
    implementation 'androidx.cardview:cardview:1.0.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.multidex:multidex:2.0.1'
    implementation 'androidx.legacy:legacy-support-v4:1.0.0'
    implementation libs.fragment
    implementation 'com.google.android.flexbox:flexbox:3.0.0'

    // ========== é¡¹ç›®æ¨¡å—ä¾èµ– ==========
    if (isLocalBuild) {
        // å¼€å‘æ—¶ä½¿ç”¨æœ¬åœ°æ¨¡å—
        implementation project(path: ':oort_imagepick_sdk')
        implementation project(path: ':ToolsMain')
        implementation project(path: ':provider_lib')
        implementation project(path: ':pullToRefershLibraryMy')
        implementation project(path: ':jcvideoplayer-lib')
        implementation project(path: ':YZxing-lib')
        implementation project(path: ':OpenGLlibrary')
        implementation project(path: ':MPChartLib')
        implementation project(path: ':liveLibrary')
        implementation project(path: ':OortWebframeLib')
        implementation project(path: ':basemodule')
        implementation project(path: ':AppStore')
        implementation project(path: ':Contacts')
        implementation project(path: ':screenrecorder')
        implementation project(path: ':AIDICert')
        implementation project(path: ':sound_recon')
        implementation project(path: ':FrameLibrary')
        implementation project(path: ':Levc-lib')
        implementation project(path: ':giraffeplayer')
        implementation project(path: ':floatview')
        implementation project(path: ':offline')
    } else {
        // å‘å¸ƒæ—¶ä½¿ç”¨è¿œç¨‹ä¾èµ–ï¼ˆJitPackæž„å»ºï¼‰
        implementation 'com.github.Bean-V:oort_imagepick_sdk:1.0.0'
        implementation 'com.github.Bean-V:ToolsMain:1.0.0'
        implementation 'com.github.Bean-V:provider_lib:1.0.0'
        implementation 'com.github.Bean-V:pullToRefershLibraryMy:1.0.0'
        implementation 'com.github.Bean-V:jcvideoplayer-lib:1.0.0'
        implementation 'com.github.Bean-V:YZxing-lib:1.0.0'
        implementation 'com.github.Bean-V:OpenGLlibrary:1.0.0'
        implementation 'com.github.Bean-V:MPChartLib:1.0.0'
        implementation 'com.github.Bean-V:liveLibrary:1.0.0'
        implementation 'com.github.Bean-V:OortWebframeLib:1.0.0'
        implementation 'com.github.Bean-V:basemodule:1.0.0'
        implementation 'com.github.Bean-V:AppStore:1.0.0'
        implementation 'com.github.Bean-V:Contacts:1.0.0'
        implementation 'com.github.Bean-V:screenrecorder:1.0.0'
        implementation 'com.github.Bean-V:AIDICert:1.0.0'
        implementation 'com.github.Bean-V:sound_recon:1.0.0'
        implementation 'com.github.Bean-V:FrameLibrary:1.0.0'
        implementation 'com.github.Bean-V:Levc-lib:1.0.0'
        implementation 'com.github.Bean-V:giraffeplayer:1.0.0'
        implementation 'com.github.Bean-V:floatview:1.0.0'
        implementation 'com.github.Bean-V:offline:1.0.0'
    }

    // ========== æ•°æ®åº“ç›¸å…³ ==========
    implementation 'androidx.room:room-runtime:2.3.0'
    kapt "androidx.room:room-compiler:2.3.0"
    implementation 'org.litepal.android:core:1.6.1'
    debugImplementation 'com.amitshekhar.android:debug-db:1.0.6' // ä»…debug

    // ========== ç½‘ç»œè¯·æ±‚ ==========
    implementation 'com.squareup.okhttp3:okhttp:3.2.0'
    implementation 'com.squareup.okhttp3:logging-interceptor:4.11.0'
    implementation files('libs/android-async-http-1.4.5.jar')

    // Retrofit + RxJava
    implementation "com.squareup.retrofit2:retrofit:2.4.0"
    implementation "com.squareup.retrofit2:converter-gson:2.4.0"
    implementation "com.squareup.retrofit2:adapter-rxjava2:2.4.0"
    implementation "io.reactivex.rxjava2:rxjava:2.2.3"
    implementation "io.reactivex.rxjava2:rxandroid:2.1.0"

    // ========== å›¾ç‰‡å¤„ç† ==========
    implementation 'com.github.bumptech.glide:glide:3.7.0'
    compileOnly 'com.github.bumptech.glide:glide:4.9.0'  // ä¾èµ–ä½†ä¸ç”¨æ‰“åŒ…
    implementation 'com.github.bumptech.glide:glide:4.12.0'
    implementation files('libs/universal-image-loader-1.9.0.jar')
    implementation 'com.makeramen:roundedimageview:2.3.0'  // åœ†å½¢å›¾ç‰‡
    implementation 'top.zibin:Luban:1.1.3'  // å›¾ç‰‡åŽ‹ç¼©
    implementation 'cc.aoeiuv020:imaging:1.0'  // å›¾ç‰‡ç¼–è¾‘

    // ========== éŸ³è§†é¢‘å¤„ç† ==========
    implementation('com.github.AoEiuV020:jjdxm_ijkplayer:1.1.1') {
        exclude group: 'com.android.support', module: 'appcompat-v7'
    }
    implementation 'com.github.ctiao:DanmakuFlameMaster:0.5.3'
    implementation 'tyrant:heartlayout:1.0.1'
    implementation 'org.jitsi.react:jitsi-meet-sdk:11.5.1'
    implementation 'com.danikula:videocache:2.7.1'  // è§†é¢‘ç¼“å­˜
    implementation 'com.github.yangjie10930:EpMedia:v0.9.5'  // è§†é¢‘å¤„ç†
    implementation 'pl.droidsonroids.gif:android-gif-drawable:1.2.28'  // GIF
    implementation 'com.huangyz0918:androidwm-light:0.1.2'  // å›¾ç‰‡æ°´å°

    // ========== æŽ¨é€æœåŠ¡ ==========
    // å°ç±³
    implementation files('libs/MiPush_SDK_Client_3_6_18.jar')
    // åŽä¸º
    implementation 'com.huawei.android.hms:push:2.5.2.300'
    implementation 'com.huawei.android.hms:base:2.5.2.300'
    // é­…æ—
    implementation 'com.meizu.flyme.internet:push-internal:3.8.1@aar'
    // vivo
    implementation files('libs/vivopushsdk_v2.3.4.jar')
    // oppo
    implementation files('libs/mcssdk-1.0.1.jar')
    // Firebase
    implementation 'com.google.firebase:firebase-core:16.0.9'
    implementation 'com.google.firebase:firebase-messaging:18.0.0'

    // ========== ç¬¬ä¸‰æ–¹ç™»å½•/æ”¯ä»˜ ==========
    // æ”¯ä»˜å®
    implementation 'com.alipay.sdk:alipaysdk-android:15.8.11'
    // QQç™»å½•
    implementation files('libs/open_sdk_r6199_lite.jar')
    // å¾®ä¿¡
    implementation 'com.tencent.mm.opensdk:wechat-sdk-android-with-mta:1.0.2'

    // ========== UIç»„ä»¶ ==========
    implementation 'com.scwang.smartrefresh:SmartRefreshLayout:1.1.0-alpha-28'  // ä¸‹æ‹‰åˆ·æ–°
    implementation 'me.leolin:ShortcutBadger:1.1.22'  // è§’æ ‡
    implementation 'com.hyman:flowlayout-lib:1.1.2'  // æµå¼å¸ƒå±€
    implementation 'in.srain.cube:grid-view-with-header-footer:1.0.12'  // GridView
    implementation 'com.github.zcweng:switch-button:0.0.3@aar'  // å¼€å…³æŒ‰é’®
    implementation 'com.daimajia.numberprogressbar:library:1.4@aar'  // è¿›åº¦æ¡
    implementation 'com.github.ceryle:FitGridView:v1.0.5'  // è¡¨æ ¼é¢æ¿
    implementation 'me.imid.swipebacklayout.lib:library:1.1.0'  // ä¾§æ»‘è¿”å›ž
    implementation 'com.leo618:zip:0.0.1'  // å¿«é€ŸSharedPreferences
    implementation 'com.joybar.calendar:librarycalendar:1.0.6'  // æ—¥åŽ†
    implementation 'com.contrarywind:Android-PickerView:4.1.7'  // é€‰æ‹©å™¨
    implementation 'com.github.xuexiangjys:XUI:1.2.1'  // UIæ¡†æž¶
    implementation 'com.github.xuexiangjys:XUpdate:2.1.4'  // æ›´æ–°æ¡†æž¶

    // ========== åœ°å›¾å®šä½ ==========
    implementation files('libs/BaiduLBS_Android.jar')
    implementation 'com.google.android.gms:play-services-maps:16.1.0'
    implementation 'com.google.android.gms:play-services-location:16.0.0'

    // ========== å³æ—¶é€šè®¯ ==========
    var smackVersion = "4.4.6"
    implementation "org.igniterealtime.smack:smack-tcp:$smackVersion"
    implementation "org.igniterealtime.smack:smack-im:$smackVersion"
    implementation "org.igniterealtime.smack:smack-extensions:$smackVersion"
    implementation "org.igniterealtime.smack:smack-xmlparser-xpp3:$smackVersion"
    implementation "org.igniterealtime.smack:smack-experimental:$smackVersion"
    implementation "org.igniterealtime.smack:smack-android:$smackVersion"
    implementation "org.igniterealtime.smack:smack-sasl-provided:$smackVersion"
    implementation "org.igniterealtime.smack:smack-resolver-minidns:$smackVersion"

    // ========== æ•°æ®å¤„ç† ==========
    implementation 'org.greenrobot:eventbus:3.1.1'
    compileOnly files('libs/fastjson-1.2.40.jar')
    implementation 'com.belerweb:pinyin4j:2.5.0'  // æ‹¼éŸ³
    implementation 'org.jsoup:jsoup:1.10.3'  // HTMLè§£æž
    implementation 'com.jakewharton.threetenabp:threetenabp:1.4.6'  // æ—¶é—´å¤„ç†

    // ========== å®‰å…¨åŠ å¯† ==========
    implementation 'org.bouncycastle:bcprov-jdk15on:1.57'
    implementation 'org.bouncycastle:bcprov-jdk15on:1.68'
    implementation 'org.bouncycastle:bcpkix-jdk15on:1.68'
    implementation 'io.jsonwebtoken:jjwt:0.9.1'  // JWT

    // ========== æ–‡ä»¶æ“ä½œ ==========
    implementation files('libs/httpmime-4.2.jar')
    compileOnly 'com.leo618:zip:0.0.1'

    // ========== æœ¬åœ°JAR/AARæ–‡ä»¶ ==========
    implementation files('libs/all-20230425.jar')
    implementation files('../provider_lib/libs/JITLogSupport1.0.0.jar')
    implementation files('libs/nineoldandroids.jar')
    implementation files('libs/ormlite-android-4.48.jar')
    implementation files('libs/ormlite-core-4.48.jar')

    // ========== æµ‹è¯•ç›¸å…³ ==========
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'androidx.test.ext:junit:1.1.1'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'

    // ========== å…¶ä»–å·¥å…·åº“ ==========
    implementation 'com.tencent.bugly:crashreport:4.1.9'  // å´©æºƒä¸ŠæŠ¥
    implementation 'com.facebook.react:react-native:0.77.2'  //
//    implementation libs.react.native
    implementation 'androidx.work:work-runtime:2.7.1'  // åŽå°ä»»åŠ¡
    implementation "log4j:log4j:1.2.17"  // æ—¥å¿—
    implementation 'com.jeremyliao:fast-sharedpreferences:0.0.1'  // å¿«é€Ÿå­˜å‚¨
    implementation('com.github.chrisbanes.bitmapcache:library:2.3') {  // Bitmapç¼“å­˜
        exclude group: 'com.google.android', module: 'support-v4'
    }

    // ========== å·²æ³¨é‡Šçš„ä¾èµ–ï¼ˆä¿ç•™ä¾›å‚è€ƒï¼‰ ==========
    /*
    //    implementation files('libs/simkeylibrary-release.aar')
    //    ç§‘è¾¾è§†é¢‘æ’­æ”¾å™¨
    //    implementation files('libs/kplayer-androidx-5.0.5-20240704-1.aar')
    //    implementation "com.kedacom.android:kplayer:5.0.5-20240704"
    //    implementation "com.kedacom:kplayer-androidx:5.0.5"
    //    æ”¯ä»˜å®æ—§ç‰ˆ
    //    implementation files('libs/alipaySdk-15.5.9-20181123210601.aar')
    //    å…¶ä»–SDK
    //    implementation files('libs/xjgarsdklibrary-release-9.2.1-2019-08-31.aar')
    //    implementation 'libs/xjgarsdklibrary-release-9.2.1-2019-08-31.aar'
    //    å¤‡æ¡ˆè¯»å–
    //    implementation files('libs/libfriapkrecord-r1.0.1.aar')
    //    implementation 'local.omm-lib:simkeylibrary-release:1.0.0'
    //    implementation 'local.omm-lib:kplayer-androidx-5.0.5-20240704-1:1.0.0'
    //    implementation 'local.omm-lib:alipaySdk-15.5.9-20181123210601:1.0.0'
    //    implementation 'local.omm-lib:xjgarsdklibrary-release-9.2.1-2019-08-31:1.0.0'
    //    implementation 'local.omm-lib:libfriapkrecord-r1.0.1:1.0.0'
    //    implementation 'com.github.ForgetAll:LoadingDialog:v1.0.1'
    //    implementation files('libs/glide-3.7.0.jar')
    //    implementation "org.jitsi.react:jitsi-meet-sdk:9.2.2"
    */
}

configurations {
    all*.exclude group: 'xpp3', module: 'xpp3'
}

// è®¾ç½®ç‰ˆæœ¬å’Œç»„
//version = '1.0.0'
//group = 'com.oort'
//afterEvaluate {
//    publishing {
//        publications {
//            release(MavenPublication) {
//                from components.release  // âœ… è‡ªåŠ¨åŒ…å«ä¾èµ–ä¿¡æ¯
//
//                // è®¾ç½® Maven åæ ‡
//                groupId = group
//                artifactId = 'omm-lib'
//                version = version
//
//                // å¯é€‰ï¼šæ·»åŠ æè¿°ç­‰ä¿¡æ¯
//                pom {
//                    description = 'OMM-SDK'
//                }
//            }
//        }
//    }
//}

// å®šä¹‰æ‰©å±•å±žæ€§ï¼Œä¾¿äºŽç®¡ç†
ext {
    PUBLISH_GROUP_ID = 'com.github.Bean-V'
    PUBLISH_ARTIFACT_ID = 'omm-sdk'  // å¿…é¡»ä¸ŽGitHubä»“åº“åä¸€è‡´ï¼
    PUBLISH_VERSION = '1.0.0'
}

afterEvaluate {
    // åœ¨é—­åŒ…å¤–éƒ¨æ•èŽ· kotlin_versionï¼Œé¿å…é…ç½®ç¼“å­˜é—®é¢˜
    def kotlinVersion = rootProject.ext.kotlin_version
    
    publishing {
        publications {
            release(MavenPublication) {
                // âš ï¸ å…³é”®ä¿®æ”¹ï¼šä¸ä½¿ç”¨ from components.release
                // åŽŸå› ï¼šfrom components.release ä¼šåœ¨ POM ä¸­å£°æ˜Žæ‰€æœ‰é¡¹ç›®ä¾èµ–
                // ä½†è¿™äº›ä¾èµ–åœ¨ JitPack ä¸Šä¸å­˜åœ¨ï¼Œå¯¼è‡´ç¬¬ä¸‰æ–¹æ— æ³•è§£æž
                
                // æ–¹æ¡ˆï¼šç›´æŽ¥å‘å¸ƒåˆå¹¶åŽçš„å®Œæ•´ AARï¼Œä¸å£°æ˜Žé¡¹ç›®ä¾èµ–
                // from components.release  // âŒ æ³¨é‡ŠæŽ‰
                
                // ä½¿ç”¨å®šä¹‰çš„å±žæ€§
                groupId = PUBLISH_GROUP_ID
                artifactId = PUBLISH_ARTIFACT_ID
                version = PUBLISH_VERSION
                
                // âœ… æ‰‹åŠ¨æŒ‡å®šè¦å‘å¸ƒçš„ AAR æ–‡ä»¶
                // å¦‚æžœ release-complete.aar å­˜åœ¨ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨åŸºç¡€ AAR
                artifact(project.provider {
                    def completeAar = new File(project.buildDir, "outputs/aar/release-complete.aar")
                    def baseAar = new File(project.buildDir, "outputs/aar/${project.name}-release.aar")
                    
                    if (completeAar.exists()) {
                        println "ðŸ“¦ [å‘å¸ƒ] ä½¿ç”¨å®Œæ•´ AAR: ${completeAar.name} (${String.format("%.2f", completeAar.size() / 1024 / 1024)} MB)"
                        return completeAar
                    } else if (baseAar.exists()) {
                        println "âš ï¸  [å‘å¸ƒ] å®Œæ•´ AAR ä¸å­˜åœ¨ï¼Œä½¿ç”¨åŸºç¡€ AAR: ${baseAar.name}"
                        return baseAar
                    } else {
                        throw new GradleException("âŒ æœªæ‰¾åˆ°å¯å‘å¸ƒçš„ AAR æ–‡ä»¶")
                    }
                })

                pom {
                    name = PUBLISH_ARTIFACT_ID
                    description = 'OMM Android SDK - Complete AAR with all dependencies'
                    url = "https://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}"

                    licenses {
                        license {
                            name = 'Apache License 2.0'
                            url = 'https://www.apache.org/licenses/LICENSE-2.0.txt'
                        }
                    }

                    developers {
                        developer {
                            id = 'Bean-V'
                            name = 'Bean V'
                            email = 'your-email@example.com'
                        }
                    }

                    scm {
                        connection = "scm:git:git://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}.git"
                        developerConnection = "scm:git:ssh://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}.git"
                        url = "https://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}"
                    }
                    
                    // âœ… å…³é”®ï¼šæ˜Žç¡®å£°æ˜Žæ²¡æœ‰é¡¹ç›®ä¾èµ–
                    // æ‰€æœ‰ä¾èµ–éƒ½å·²ç»åˆå¹¶åˆ° AAR ä¸­äº†
                    withXml {
                        def dependenciesNode = asNode().appendNode('dependencies')
                        
                        // åªä¿ç•™å¿…è¦çš„å¤–éƒ¨ä¾èµ–ï¼ˆAndroidXã€Kotlin ç­‰ï¼‰
                        // è¿™äº›ä¾èµ–é€šå¸¸ç¬¬ä¸‰æ–¹é¡¹ç›®ä¹Ÿä¼šæœ‰ï¼Œä¸ä¼šå†²çª
                        def essentialDeps = [
                            // AndroidX æ ¸å¿ƒåº“
                            [group: 'androidx.appcompat', name: 'appcompat', version: '1.3.1'],
                            [group: 'com.google.android.material', name: 'material', version: '1.4.0'],
                            [group: 'androidx.recyclerview', name: 'recyclerview', version: '1.2.1'],
                            [group: 'androidx.constraintlayout', name: 'constraintlayout', version: '2.1.4'],
                            
                            // Kotlin
                            [group: 'org.jetbrains.kotlin', name: 'kotlin-stdlib', version: kotlinVersion],
                        ]
                        
                        essentialDeps.each { dep ->
                            def dependencyNode = dependenciesNode.appendNode('dependency')
                            dependencyNode.appendNode('groupId', dep.group)
                            dependencyNode.appendNode('artifactId', dep.name)
                            dependencyNode.appendNode('version', dep.version)
                            dependencyNode.appendNode('scope', 'compile')
                        }
                        
                        println "âœ… [POM] å·²é…ç½®æœ€å°ä¾èµ–é›†ï¼ˆ${essentialDeps.size()} ä¸ªï¼‰"
                    }
                }
            }
        }
    }
}


// ================================================
// Variant API: åˆå¹¶æ‰€æœ‰ä¾èµ–åˆ°å•ä¸ª AAR
// ================================================

import com.android.build.api.variant.AndroidComponentsExtension
import org.gradle.api.DefaultTask
import org.gradle.api.file.DirectoryProperty
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.file.ConfigurableFileCollection
import org.gradle.api.tasks.InputDirectory
import org.gradle.api.tasks.InputFiles
import org.gradle.api.tasks.OutputFile
import org.gradle.api.tasks.TaskAction
import org.gradle.api.artifacts.ProjectDependency
import java.util.jar.JarOutputStream
import java.util.zip.ZipEntry

// è‡ªå®šä¹‰ä»»åŠ¡ï¼šåˆå¹¶æ‰€æœ‰ä¾èµ–åˆ° AAR
abstract class MergeAllDependenciesTask extends DefaultTask {
    
    @InputDirectory
    abstract DirectoryProperty getAarDirectory()
    
    @InputFiles
    abstract ConfigurableFileCollection getDependencyFiles()
    
    @OutputFile
    abstract RegularFileProperty getOutputAar()
    
    @TaskAction
    void mergeAllDependencies() {
        println "ðŸ”„ [Variant API] å¼€å§‹åˆå¹¶æ‰€æœ‰ä¾èµ–..."
        
        // æŸ¥æ‰¾åŽŸå§‹ AAR
        def aarDir = aarDirectory.get().asFile
        def originalAar = aarDir.listFiles()?.find { it.name.endsWith('.aar') && it.name.contains('release') }
        
        if (!originalAar || !originalAar.exists()) {
            println "âŒ åŽŸå§‹ AAR ä¸å­˜åœ¨äºŽ: ${aarDir.path}"
            throw new GradleException("Original AAR not found")
        }
        
        println "ðŸ“¦ æ‰¾åˆ°åŽŸå§‹ AAR: ${originalAar.name} (${String.format("%.2f", originalAar.size() / 1024 / 1024)} MB)"
        
        // åˆ›å»ºä¸´æ—¶ç›®å½•
        def tempDir = new File(project.buildDir, "temp/variant-merge/")
        tempDir.deleteDir()
        tempDir.mkdirs()
        
        // è§£åŽ‹åŽŸå§‹ AAR
        project.copy {
            from project.zipTree(originalAar)
            into tempDir
        }
        println "  âœ… è§£åŽ‹åŽŸå§‹ AAR"
        
        // åˆ›å»ºåˆå¹¶çš„ classes ç›®å½•
        def mergedClassesDir = new File(tempDir, "merged-classes/")
        mergedClassesDir.mkdirs()
        
        // å…ˆå¤åˆ¶åŽŸå§‹çš„ classes.jar å†…å®¹
        def originalClassesJar = new File(tempDir, "classes.jar")
        if (originalClassesJar.exists()) {
            project.copy {
                from project.zipTree(originalClassesJar)
                include '**/*.class'
                into mergedClassesDir
                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
            }
            println "  âœ… æå–åŽŸå§‹ classes.jar"
        }
        
        // æ”¶é›†æ‰€æœ‰ä¾èµ–çš„ç±»æ–‡ä»¶
        def dependencyCount = 0
        def depFiles = dependencyFiles.files
        
        println "\nðŸ“š å¼€å§‹åˆå¹¶ä¾èµ– (å…± ${depFiles.size()} ä¸ªæ–‡ä»¶)..."
        
        depFiles.each { file ->
            if (file.exists()) {
                dependencyCount++
                
                if (file.name.endsWith('.jar')) {
                    // åˆå¹¶ JAR æ–‡ä»¶
                    try {
                        project.copy {
                            from project.zipTree(file)
                            include '**/*.class'
                            exclude 'META-INF/**'
                            exclude 'module-info.class'
                            into mergedClassesDir
                            duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                        }
                        println "  âœ… åˆå¹¶ JAR: ${file.name}"
                    } catch (Exception e) {
                        println "  âš ï¸  è·³è¿‡ JAR: ${file.name} - ${e.message}"
                    }
                    
                } else if (file.name.endsWith('.aar')) {
                    // åˆå¹¶ AAR ä¸­çš„ classes.jar å’Œèµ„æº
                    try {
                        def tempAarDir = new File(tempDir, "temp-aar-${file.name.replace('.aar', '')}/")
                        tempAarDir.mkdirs()
                        
                        // è§£åŽ‹æ•´ä¸ª AAR
                        project.copy {
                            from project.zipTree(file)
                            into tempAarDir
                        }
                        
                        // 1. åˆå¹¶ classes.jar
                        def classesJar = new File(tempAarDir, "classes.jar")
                        if (classesJar.exists()) {
                            project.copy {
                                from project.zipTree(classesJar)
                                include '**/*.class'
                                exclude 'META-INF/**'
                                exclude 'module-info.class'
                                into mergedClassesDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                        }
                        
                        // 2. åˆå¹¶èµ„æºæ–‡ä»¶ (res ç›®å½•)
                        def resDir = new File(tempAarDir, "res")
                        if (resDir.exists() && resDir.isDirectory()) {
                            def targetResDir = new File(tempDir, "res")
                            targetResDir.mkdirs()
                            
                            project.copy {
                                from resDir
                                into targetResDir
                                // ä½¿ç”¨ WARN ç­–ç•¥ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªä½†è­¦å‘Šå†²çª
                                // è¿™æ ·å¯ä»¥çœ‹åˆ°å“ªäº›èµ„æºæœ‰å†²çª
                                duplicatesStrategy = DuplicatesStrategy.WARN
                            }
                        }
                        
                        // 3. åˆå¹¶ R.txt (èµ„æº ID æ–‡ä»¶)
                        def rTxt = new File(tempAarDir, "R.txt")
                        if (rTxt.exists()) {
                            def targetRTxt = new File(tempDir, "R.txt")
                            if (targetRTxt.exists()) {
                                // è¿½åŠ å†…å®¹ï¼Œé¿å…è¦†ç›–
                                targetRTxt.append(rTxt.text)
                            } else {
                                project.copy {
                                    from rTxt
                                    into tempDir
                                }
                            }
                        }
                        
                        // 4. åˆå¹¶ assets ç›®å½•
                        def assetsDir = new File(tempAarDir, "assets")
                        if (assetsDir.exists() && assetsDir.isDirectory()) {
                            def targetAssetsDir = new File(tempDir, "assets")
                            targetAssetsDir.mkdirs()
                            
                            project.copy {
                                from assetsDir
                                into targetAssetsDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                        }
                        
                        // 5. åˆå¹¶ jni ç›®å½• (native libraries)
                        def jniDir = new File(tempAarDir, "jni")
                        if (jniDir.exists() && jniDir.isDirectory()) {
                            def targetJniDir = new File(tempDir, "jni")
                            targetJniDir.mkdirs()
                            
                            project.copy {
                                from jniDir
                                into targetJniDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                        }
                        
                        // 6. åˆå¹¶ libs ç›®å½• (é¢å¤–çš„ JAR ä¾èµ–)
                        def libsDir = new File(tempAarDir, "libs")
                        if (libsDir.exists() && libsDir.isDirectory()) {
                            def targetLibsDir = new File(tempDir, "libs")
                            targetLibsDir.mkdirs()
                            
                            project.copy {
                                from libsDir
                                into targetLibsDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                        }
                        
                        // 7. åˆå¹¶ proguard.txt (ProGuard è§„åˆ™)
                        def proguardTxt = new File(tempAarDir, "proguard.txt")
                        if (proguardTxt.exists()) {
                            def targetProguardTxt = new File(tempDir, "proguard.txt")
                            if (targetProguardTxt.exists()) {
                                // è¿½åŠ å†…å®¹ï¼Œé¿å…è¦†ç›–
                                targetProguardTxt.append("\n# From ${file.name}\n")
                                targetProguardTxt.append(proguardTxt.text)
                            } else {
                                project.copy {
                                    from proguardTxt
                                    into tempDir
                                }
                            }
                        }
                        
                        // 8. åˆå¹¶ consumer-proguard-rules.pro (æ¶ˆè´¹è€… ProGuard è§„åˆ™)
                        def consumerProguard = new File(tempAarDir, "consumer-proguard-rules.pro")
                        if (consumerProguard.exists()) {
                            def targetConsumerProguard = new File(tempDir, "consumer-proguard-rules.pro")
                            if (targetConsumerProguard.exists()) {
                                // è¿½åŠ å†…å®¹ï¼Œé¿å…è¦†ç›–
                                targetConsumerProguard.append("\n# From ${file.name}\n")
                                targetConsumerProguard.append(consumerProguard.text)
                            } else {
                                project.copy {
                                    from consumerProguard
                                    into tempDir
                                }
                            }
                        }
                        
                        // 9. åˆå¹¶ public.txt (å…¬å…±èµ„æºåˆ—è¡¨)
                        def publicTxt = new File(tempAarDir, "public.txt")
                        if (publicTxt.exists()) {
                            def targetPublicTxt = new File(tempDir, "public.txt")
                            if (targetPublicTxt.exists()) {
                                // è¿½åŠ å†…å®¹ï¼Œé¿å…è¦†ç›–
                                targetPublicTxt.append(publicTxt.text)
                            } else {
                                project.copy {
                                    from publicTxt
                                    into tempDir
                                }
                            }
                        }
                        
                        // 10. åˆå¹¶ aidl ç›®å½• (AIDL æŽ¥å£æ–‡ä»¶)
                        def aidlDir = new File(tempAarDir, "aidl")
                        if (aidlDir.exists() && aidlDir.isDirectory()) {
                            def targetAidlDir = new File(tempDir, "aidl")
                            targetAidlDir.mkdirs()
                            
                            project.copy {
                                from aidlDir
                                into targetAidlDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                        }
                        
                        // 11. åˆå¹¶ annotations.zip (æ³¨è§£æ–‡ä»¶)
                        def annotationsZip = new File(tempAarDir, "annotations.zip")
                        if (annotationsZip.exists()) {
                            def targetAnnotationsZip = new File(tempDir, "annotations.zip")
                            if (!targetAnnotationsZip.exists()) {
                                project.copy {
                                    from annotationsZip
                                    into tempDir
                                }
                            }
                        }
                        
                        // 12. åˆå¹¶ prefab ç›®å½• (C/C++ åº“é…ç½®)
                        def prefabDir = new File(tempAarDir, "prefab")
                        if (prefabDir.exists() && prefabDir.isDirectory()) {
                            def targetPrefabDir = new File(tempDir, "prefab")
                            targetPrefabDir.mkdirs()
                            
                            project.copy {
                                from prefabDir
                                into targetPrefabDir
                                duplicatesStrategy = DuplicatesStrategy.EXCLUDE
                            }
                        }
                        
                        // 13. åˆå¹¶ navigation.json (Navigation ç»„ä»¶é…ç½®)
                        def navigationJson = new File(tempAarDir, "navigation.json")
                        if (navigationJson.exists()) {
                            def targetNavigationJson = new File(tempDir, "navigation.json")
                            if (!targetNavigationJson.exists()) {
                                project.copy {
                                    from navigationJson
                                    into tempDir
                                }
                            }
                        }
                        
                        println "  âœ… åˆå¹¶ AAR: ${file.name}"
                        
                        tempAarDir.deleteDir()
                    } catch (Exception e) {
                        println "  âš ï¸  è·³è¿‡ AAR: ${file.name} - ${e.message}"
                    }
                }
            }
        }
        
        println "\nðŸ“Š å…±å¤„ç† ${dependencyCount} ä¸ªä¾èµ–æ–‡ä»¶"
        
        // âœ… é‡è¦ï¼šæœ€åŽå†æ¬¡å¤åˆ¶ omm-lib è‡ªå·±çš„èµ„æºï¼Œç¡®ä¿ä¼˜å…ˆçº§æœ€é«˜
        println "\nðŸ” ç¡®ä¿ omm-lib è‡ªèº«èµ„æºä¼˜å…ˆçº§æœ€é«˜..."
        project.copy {
            from project.zipTree(originalAar)
            include 'res/**'
            into tempDir
            duplicatesStrategy = DuplicatesStrategy.INCLUDE  // è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
        }
        println "  âœ… omm-lib èµ„æºå·²ç¡®ä¿ä¼˜å…ˆ"
        
        // åˆ›å»ºæ–°çš„ classes.jar
        if (mergedClassesDir.listFiles()?.size() > 0) {
            println "ðŸ“¦ åˆ›å»ºåˆå¹¶çš„ classes.jar..."
            
            def mergedJarFile = new File(tempDir, "classes-merged.jar")
            def jarOutput = new JarOutputStream(new FileOutputStream(mergedJarFile))
            
            // æ”¶é›†æ‰€æœ‰ class æ–‡ä»¶
            def classFiles = []
            mergedClassesDir.eachFileRecurse { file ->
                if (file.isFile() && file.name.endsWith('.class')) {
                    classFiles << file
                }
            }
            
            // å†™å…¥ JAR
            classFiles.each { file ->
                def entryName = mergedClassesDir.toURI().relativize(file.toURI()).toString()
                jarOutput.putNextEntry(new ZipEntry(entryName))
                jarOutput.write(file.bytes)
                jarOutput.closeEntry()
            }
            jarOutput.close()
            
            // æ›¿æ¢åŽŸå§‹çš„ classes.jar
            if (originalClassesJar.exists()) {
                originalClassesJar.delete()
            }
            mergedJarFile.renameTo(originalClassesJar)
            
            println "âœ… ç±»æ–‡ä»¶åˆå¹¶å®Œæˆ (${classFiles.size()} ä¸ªç±»)"
        }
        
        // æ¸…ç†ä¸´æ—¶ç›®å½•
        mergedClassesDir.deleteDir()
        new File(tempDir, "temp-aar/").deleteDir()
        
        // é‡æ–°æ‰“åŒ…ä¸º AAR
        def outputFile = outputAar.get().asFile
        outputFile.parentFile.mkdirs()
        
        project.ant.zip(destfile: outputFile) {
            fileset(dir: tempDir) {
                include(name: "**/*")
                exclude(name: "merged-classes/**")
                exclude(name: "temp-aar*/**")
            }
        }
        
        println """
ðŸŽ‰ [Variant API] ä¸€ç«™å¼æ‰“åŒ…å®Œæˆï¼
ðŸ“Š ç»Ÿè®¡ä¿¡æ¯:
  - åŽŸå§‹ AAR: ${String.format("%.2f", originalAar.size() / 1024 / 1024)} MB
  - åˆå¹¶åŽ AAR: ${String.format("%.2f", outputFile.size() / 1024 / 1024)} MB
  - å¤„ç†ä¾èµ–æ•°: ${dependencyCount}
ðŸ“ è¾“å‡ºæ–‡ä»¶: ${outputFile.path}
        """
        
        // æ¸…ç†ä¸´æ—¶ç›®å½•
        tempDir.deleteDir()
    }
}

// ä½¿ç”¨ Variant API æ³¨å†Œä»»åŠ¡
androidComponents {
    onVariants(selector().withBuildType("release")) { variant ->
        
        println "ðŸ”§ [é…ç½®é˜¶æ®µ] æ­£åœ¨ä¸º ${variant.name} å˜ä½“é…ç½®åˆå¹¶ä»»åŠ¡..."
        
        // æ³¨å†Œåˆå¹¶ä¾èµ–ä»»åŠ¡
        def mergeTask = project.tasks.register(
            "merge${variant.name.capitalize()}Dependencies",
            MergeAllDependenciesTask.class
        ) { task ->
            // è¾“å…¥ï¼šåŽŸå§‹ AAR ç›®å½•
            task.aarDirectory.set(
                project.layout.buildDirectory.dir("outputs/aar")
            )
            
            // ä¾èµ– bundleReleaseAar ä»»åŠ¡
            task.dependsOn("bundle${variant.name.capitalize()}Aar")
            
            // ç¡®ä¿æ‰€æœ‰é¡¹ç›®ä¾èµ–çš„ AAR éƒ½å·²æž„å»º
            def projectDeps = []
            project.configurations.implementation.allDependencies.each { dep ->
                if (dep instanceof ProjectDependency) {
                    def depProject = dep.dependencyProject
                    projectDeps << depProject.name
                    
                    // ä¾èµ–æ¯ä¸ªé¡¹ç›®çš„ bundle ä»»åŠ¡
                    def bundleTaskName = "bundle${variant.name.capitalize()}Aar"
                    try {
                        def depBundleTask = depProject.tasks.findByName(bundleTaskName)
                        if (depBundleTask) {
                            task.dependsOn(depBundleTask)
                            println "  âœ… æ·»åŠ ä¾èµ–: ${depProject.name}:${bundleTaskName}"
                        }
                    } catch (Exception e) {
                        println "  âš ï¸  é…ç½®ä¾èµ–å¤±è´¥: ${depProject.name} - ${e.message}"
                    }
                }
            }
            
            println "ðŸ“¦ é¡¹ç›®ä¾èµ–æ€»æ•°: ${projectDeps.size()}"
            
            // è¾“å…¥ï¼šä¾èµ–æ–‡ä»¶é›†åˆ - åœ¨æ‰§è¡Œé˜¶æ®µåŠ¨æ€æ”¶é›†
            task.dependencyFiles.from(
                project.provider {
                    println "\nðŸ” [æ‰§è¡Œé˜¶æ®µ] å¼€å§‹æ”¶é›†ä¾èµ–æ–‡ä»¶..."
                    def files = []
                    def projectAars = []
                    def externalJars = []
                    def externalAars = []
                    
                    // 1. æ”¶é›†é¡¹ç›®ä¾èµ–çš„ AAR
                    println "ðŸ“¦ æ”¶é›†é¡¹ç›®ä¾èµ–çš„ AAR..."
                    project.configurations.implementation.allDependencies.each { dep ->
                        if (dep instanceof ProjectDependency) {
                            def depProject = dep.dependencyProject
                            def aarDir = new File(depProject.buildDir, "outputs/aar")
                            
                            if (aarDir.exists()) {
                                def found = false
                                aarDir.listFiles()?.each { file ->
                                    if (file.name.endsWith('.aar') && file.name.contains('release')) {
                                        files << file
                                        projectAars << file.name
                                        found = true
                                        println "  âœ… ${depProject.name}: ${file.name} (${String.format("%.2f", file.size() / 1024 / 1024)} MB)"
                                    }
                                }
                                if (!found) {
                                    println "  âš ï¸  ${depProject.name}: æœªæ‰¾åˆ° release AAR"
                                }
                            } else {
                                println "  âŒ ${depProject.name}: AAR ç›®å½•ä¸å­˜åœ¨"
                            }
                        }
                    }
                    
                    // 2. æ”¶é›†å¤–éƒ¨ä¾èµ–å’Œæ–‡ä»¶ä¾èµ–
                    println "\nðŸ“š æ”¶é›†å¤–éƒ¨ä¾èµ–..."
                    try {
                        // ä½¿ç”¨ runtimeClasspath é…ç½®æ¥è§£æžä¾èµ–
                        def runtimeConfig = project.configurations.findByName('releaseRuntimeClasspath')
                        if (!runtimeConfig) {
                            runtimeConfig = project.configurations.findByName('runtimeClasspath')
                        }
                        
                        if (runtimeConfig) {
                            def resolvedArtifacts = runtimeConfig.resolvedConfiguration.resolvedArtifacts
                            println "  è§£æžåˆ° ${resolvedArtifacts.size()} ä¸ªä¾èµ–"
                            
                            resolvedArtifacts.each { artifact ->
                                def file = artifact.file
                                
                                if (file.exists()) {
                                    def isProjectAar = projectAars.any { it == file.name }
                                    
                                    if (!isProjectAar) {
                                        if (file.name.endsWith('.jar')) {
                                            files << file
                                            externalJars << file.name
                                            println "  âœ… JAR: ${file.name}"
                                        } else if (file.name.endsWith('.aar')) {
                                            files << file
                                            externalAars << file.name
                                            println "  âœ… AAR: ${file.name}"
                                        }
                                    }
                                }
                            }
                        } else {
                            println "  âš ï¸  æœªæ‰¾åˆ°å¯è§£æžçš„ runtime é…ç½®"
                        }
                    } catch (Exception e) {
                        println "  âŒ è§£æžå¤–éƒ¨ä¾èµ–æ—¶å‡ºé”™: ${e.message}"
                        e.printStackTrace()
                    }
                    
                    println "\nðŸ“Š ä¾èµ–æ”¶é›†ç»Ÿè®¡:"
                    println "  - é¡¹ç›® AAR: ${projectAars.size()}"
                    println "  - å¤–éƒ¨ AAR: ${externalAars.size()}"
                    println "  - å¤–éƒ¨ JAR: ${externalJars.size()}"
                    println "  - æ€»è®¡: ${files.size()} ä¸ªæ–‡ä»¶"
                    
                    if (files.isEmpty()) {
                        println "\nâš ï¸  è­¦å‘Š: æœªæ”¶é›†åˆ°ä»»ä½•ä¾èµ–æ–‡ä»¶ï¼"
                    }
                    
                    return files
                }
            )
            
            // è¾“å‡ºï¼šåˆå¹¶åŽçš„ AAR
            task.outputAar.set(
                new File(project.buildDir, "outputs/aar/${variant.name}-complete.aar")
            )
            
            task.group = 'build'
            task.description = "åˆå¹¶ ${variant.name} çš„æ‰€æœ‰ä¾èµ–åˆ°å•ä¸ª AAR"
        }
        
        println "âœ… å·²æ³¨å†Œä»»åŠ¡: merge${variant.name.capitalize()}Dependencies"
    }
}

// ä¸€é”®æž„å»ºä»»åŠ¡
task buildCompleteAar {
    group = 'build'
    description = 'æž„å»ºåŒ…å«æ‰€æœ‰ä¾èµ–çš„å®Œæ•´ AAR'
    
    dependsOn 'clean', 'mergeReleaseDependencies'
    
    doLast {
        println """
ðŸŽ‰ å®Œæ•´ AAR æž„å»ºå®Œæˆï¼
ðŸ“ è¾“å‡ºæ–‡ä»¶: build/outputs/aar/release-complete.aar

ç¬¬ä¸‰æ–¹ä½¿ç”¨æ–¹æ³•:
1. å°† release-complete.aar é‡å‘½åä¸º omm-sdk-complete.aar
2. å¤åˆ¶åˆ°ç¬¬ä¸‰æ–¹é¡¹ç›®çš„ libs ç›®å½•
3. åœ¨ build.gradle ä¸­æ·»åŠ :
   implementation(name: 'omm-sdk-complete', ext: 'aar')
        """
    }
}

// ç¡®ä¿ä»»åŠ¡æ‰§è¡Œé¡ºåº
afterEvaluate {
    def mergeTask = tasks.findByName('mergeReleaseDependencies')
    if (mergeTask) {
        mergeTask.mustRunAfter 'clean'
    }
}
