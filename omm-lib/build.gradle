apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-kapt'
apply plugin: 'maven-publish'

buildscript {
    ext {

//        appId = 'com.oortcloud.rjt' // 奥陌陌//ommOA01
        channel = '@string/app_name' // bugly上显示的渠道名，

        buglyAppId = '438ff58c22' // bugly配置的appId,
        baiduApiKey = 'Q7wb91P5U7RnKkcwOTu8AQtBpsujKmzu' // baidu配置的apiKey,
        googleApiKey = 'AIzaSyAbJjDWUPU6sRsQccNMp8E3soO7YGSkTIg' // google地图配置的apiKey,
        huaweiAppId = '102058269' // 华为推送配置的appId,
        xiaomiAppId = '2882303761517581074' // 小米推送配置的appId,
        xiaomiAppKey = '5951758130074' // 小米推送配置的appKey,
        meizuAppId = '118639' // 魅族推送配置的appId,
        meizuAppKey = '198cfa2fa66544ba87ab05874ba22868' // 魅族推送配置的appKey,
        vivoAppId = '18094' // VIVO推送配置的appId,
        vivoAppKey = '41337891-3989-4db0-8894-6ecbf313cefd' // VIVO推送配置的appKey,
        oppoAppKey = 'dIHycN8J0NsCokwSGss8sskw4' // OPPO推送配置的appKey,
        oppoAppSecret = 'b9f6927d9eCD0159532dA5c2e1118eC8' // OPPO推送配置的secret,
        wechatAppId = '' // 微信相关的appId,
        qqAppId = '' // QQ相关的appId,

        buglyAppChannel = channel
        date = new Date().format("yyyyMMdd")
        buglyVersionNameSuffix = '' + '-' + date
    }
}
// 判断存在谷歌服务配置文件才启用谷歌服务，
def googleJson = file('google-services.json')
if (googleJson.exists() && googleJson.readLines().any { it.contains(appId) }) {
    apply plugin: 'com.google.gms.google-services'
    // 谷歌服务4.2版本有已知bug会导致其他无关依赖(smack4.3.4)莫名冲突，禁用相关检查解决，
    // https://github.com/invertase/react-native-firebase/issues/1676
    //noinspection UnnecessaryQualifiedReference
    com.google.gms.googleservices.GoogleServicesPlugin.config.disableVersionCheck = true
}
android {
    lintOptions {
        abortOnError false
        checkReleaseBuilds false
    }

    packagingOptions {//加上这些代码
        pickFirst 'lib/armeabi-v7a/libijkplayer.so'
        pickFirst 'lib/armeabi-v8a/libijkplayer.so'
        pickFirst 'lib/arm64-v8a/libijkplayer.so'
        pickFirst 'lib/x86/libijkplayer.so'
        pickFirst 'lib/x86_64/libijkplayer.so'

        pickFirst 'lib/armeabi-v7a/libijksdl.so'
        pickFirst 'lib/armeabi-v8a/libijksdl.so'
        pickFirst 'lib/arm64-v8a/libijksdl.so'
        pickFirst 'lib/x86/libijksdl.so'
        pickFirst 'lib/x86_64/libijksdl.so'

        pickFirst 'lib/armeabi-v7a/libijkffmpeg.so'
        pickFirst 'lib/armeabi-v8a/libijkffmpeg.so'
        pickFirst 'lib/arm64-v8a/libijkffmpeg.so'
        pickFirst 'lib/x86/libijkffmpeg.so'
        pickFirst 'lib/x86_64/libijkffmpeg.so'

        pickFirst 'lib/*/libc++_shared.so'

        exclude 'META-INF/LICENSE.txt'
        exclude 'META-INF/NOTICE.txt'

        exclude 'META-INF/*.kotlin_module'
        exclude 'META-INF/rxjava.properties'
    }

    compileSdkVersion compile_version

    namespace "com.oort.weichat"

    defaultConfig {
//        applicationId appId


        buildFeatures {
            buildConfig true
            aidl true
        }
        //版本号，不要出现4了
        versionCode     1013
        versionName "1.0.13" //版本号，不要出现4了
        //版本号，不要出现4了
        minSdkVersion min_version
        targetSdkVersion target_version

        vectorDrawables.useSupportLibrary = true

        ndk {

            abiFilters 'arm64-v8a'
            //abiFilters  "armeabi",//"armeabi-v7a" //,"x86_64"
//             abiFilters "armeabi", "armeabi-v7a", "arm64-v8a", "x86", "x86_64"

        }

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        multiDexEnabled = true
        buildConfigField('String', "BUGLY_APP_ID", '"' + buglyAppId + '"')
        buildConfigField('String', "BUGLY_APP_CHANNEL", '"' + buglyAppChannel + '"')
        buildConfigField('String', "XIAOMI_APP_ID", '"' + xiaomiAppId + '"')
        buildConfigField('String', "XIAOMI_APP_KEY", '"' + xiaomiAppKey + '"')
        buildConfigField('String', "MEIZU_APP_ID", '"' + meizuAppId + '"')
        buildConfigField('String', "MEIZU_APP_KEY", '"' + meizuAppKey + '"')
        buildConfigField('String', "OPPO_APP_KEY", '"' + oppoAppKey + '"')
        buildConfigField('String', "OPPO_APP_SECRET", '"' + oppoAppSecret + '"')
        buildConfigField('String', "GOOGLE_API_KEY", '"' + googleApiKey + '"')
        buildConfigField('String', "WECHAT_APP_ID", '"' + wechatAppId + '"')
        buildConfigField('String', "QQ_APP_ID", '"' + qqAppId + '"')
        manifestPlaceholders = [
//                APP_ID        : appId,
            BAIDU_API_KEY : baiduApiKey,
            VIVO_APP_ID   : vivoAppId,
            VIVO_APP_KEY  : vivoAppKey,
            GOOGLE_API_KEY: googleApiKey,
            HUAWEI_APP_ID : huaweiAppId,
            QQ_APP_ID     : qqAppId,
        ]

        resConfigs "en", "zh-rCN","ar"
        externalNativeBuild {
            cmake {
                arguments "-DANDROID_SUPPORT_FLEXIBLE_PAGE_SIZES=ON", "-DANDROID_STL=c++_shared"
                cppFlags "-std=c++17"
                cFlags "-DANDROID_PLATFORM=android-26"
            }
        }
    }

    // 高版本as中installRelease不会依赖assembleRelease也就不会复制apk,
    afterEvaluate {
        // 没配置签名的话，就没有installRelease，
        if (tasks.findByName('installRelease')) {
            installRelease.dependsOn 'assembleRelease'
        }
    }
    // multiDex的一些相关配置，这样配置可以让你的编译速度更快
    dexOptions {
        // 让它不要对Lib做preDexing
        preDexLibraries = false
        // 开启incremental dexing,优化编译效率，这个功能android studio默认是关闭的
        // incremental true
        // 增加java堆内存大小
        javaMaxHeapSize "4g"
    }

    // 单元测试用，
    testOptions {
        unitTests.returnDefaultValues = true
    }

    // 进行JAVA 的版本配置，使用对应版本的一些新特性
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    useLibrary 'org.apache.http.legacy'



    buildTypes {
        release {
            minifyEnabled false

            //  minifyEnabled true // 可保留混淆，但需配合上述 ProGuard 规则
            shrinkResources false // 关键：关闭资源压缩，避免 config.xml 结构被改
            // 混淆文件位置
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            buildConfigField('String', "VERSION_NAME_SUFFIX", '"' + buglyVersionNameSuffix + '"')
        }
        debug {
            buildConfigField('String', "VERSION_NAME_SUFFIX", '"' + "-DEBUG" + '"')
            debuggable true
        }
    }

    // 签名信息从signing.properties中获取，
    // debug和release使用相同签名，以便用debug包覆盖release包从而调试，
    // 如果没有，就会使用默认debug签名，
    def signingFile = rootProject.file('signing.properties')
    if (signingFile.exists()) {
        def input = signingFile.newInputStream()
        def p = new Properties()
        p.load(input)
        // 签名文件存在才配置签名，
        def jks = rootProject.file(p['storeFile'])
        if (jks.exists()) {
            signingConfigs {
                config {
                    keyAlias p['keyAlias']
                    keyPassword p['keyPassword']
                    storeFile jks
                    storePassword p['storePassword']
                    v1SigningEnabled true
                    v2SigningEnabled true
                }
            }
            buildTypes {
                debug {
                    signingConfig signingConfigs.config
                }
                release {
                    signingConfig signingConfigs.config
                }
            }
        }
    }
    repositories {
        mavenLocal()  // ← 这行很重要！
        // 也可以显式指定本地仓库路径
        maven {
            url = uri("${System.getProperty('user.home')}/.m2/repository")
        }
//
//        flatDir {
//            dirs '../OortWebframeLib/libs'   // aar目录
//        }


    }
}

configurations.all {
    resolutionStrategy.eachDependency { details ->
        // jitsi和imaging两个库都依赖fresco版本冲突了，
//        if (details.requested.group == 'com.facebook.fresco') {
//            details.useVersion '2.0.0'
//        }
    }
    // 1.1.0会导致安卓5上webview崩溃，https://stackoverflow.com/a/58131421
    // 准确说是低版本webView的bug，普遍存在国产安卓5上，
    resolutionStrategy.force 'androidx.appcompat:appcompat:1.3.1'
}

configurations.maybeCreate("publishAar")

// 在文件顶部定义变量
def isLocalBuild = false
dependencies {
    // ========== AndroidX 核心库 ==========
    implementation 'androidx.appcompat:appcompat:1.3.1'
    implementation 'com.google.android.material:material:1.4.0'
    implementation 'androidx.recyclerview:recyclerview:1.2.1'
    implementation 'androidx.gridlayout:gridlayout:1.0.0'
    implementation 'androidx.cardview:cardview:1.0.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.multidex:multidex:2.0.1'
    implementation 'androidx.legacy:legacy-support-v4:1.0.0'
    implementation libs.fragment
    implementation 'com.google.android.flexbox:flexbox:3.0.0'

    // ========== 项目模块依赖 ==========
    if (isLocalBuild) {
        // 开发时使用本地模块
        implementation project(path: ':oort_imagepick_sdk')
        implementation project(path: ':ToolsMain')
        implementation project(path: ':provider_lib')
        implementation project(path: ':pullToRefershLibraryMy')
        implementation project(path: ':jcvideoplayer-lib')
        implementation project(path: ':YZxing-lib')
        implementation project(path: ':OpenGLlibrary')
        implementation project(path: ':MPChartLib')
        implementation project(path: ':liveLibrary')
        implementation project(path: ':OortWebframeLib')
        implementation project(path: ':basemodule')
        implementation project(path: ':AppStore')
        implementation project(path: ':Contacts')
        implementation project(path: ':screenrecorder')
        implementation project(path: ':AIDICert')
        implementation project(path: ':sound_recon')
        implementation project(path: ':FrameLibrary')
        implementation project(path: ':Levc-lib')
        implementation project(path: ':giraffeplayer')
        implementation project(path: ':floatview')
        implementation project(path: ':offline')
    } else {
        // 发布时使用远程依赖（JitPack构建）
        implementation 'com.github.Bean-V:oort_imagepick_sdk:1.0.0'
        implementation 'com.github.Bean-V:ToolsMain:1.0.0'
        implementation 'com.github.Bean-V:provider_lib:1.0.0'
        implementation 'com.github.Bean-V:pullToRefershLibraryMy:1.0.0'
        implementation 'com.github.Bean-V:jcvideoplayer-lib:1.0.0'
        implementation 'com.github.Bean-V:YZxing-lib:1.0.0'
        implementation 'com.github.Bean-V:OpenGLlibrary:1.0.0'
        implementation 'com.github.Bean-V:MPChartLib:1.0.0'
        implementation 'com.github.Bean-V:liveLibrary:1.0.0'
        implementation 'com.github.Bean-V:OortWebframeLib:1.0.0'
        implementation 'com.github.Bean-V:basemodule:1.0.0'
        implementation 'com.github.Bean-V:AppStore:1.0.0'
        implementation 'com.github.Bean-V:Contacts:1.0.0'
        implementation 'com.github.Bean-V:screenrecorder:1.0.0'
        implementation 'com.github.Bean-V:AIDICert:1.0.0'
        implementation 'com.github.Bean-V:sound_recon:1.0.0'
        implementation 'com.github.Bean-V:FrameLibrary:1.0.0'
        implementation 'com.github.Bean-V:Levc-lib:1.0.0'
        implementation 'com.github.Bean-V:giraffeplayer:1.0.0'
        implementation 'com.github.Bean-V:floatview:1.0.0'
        implementation 'com.github.Bean-V:offline:1.0.0'
    }

    // ========== 数据库相关 ==========
    implementation 'androidx.room:room-runtime:2.3.0'
    kapt "androidx.room:room-compiler:2.3.0"
    implementation 'org.litepal.android:core:1.6.1'
    debugImplementation 'com.amitshekhar.android:debug-db:1.0.6' // 仅debug

    // ========== 网络请求 ==========
    implementation 'com.squareup.okhttp3:okhttp:3.2.0'
    implementation 'com.squareup.okhttp3:logging-interceptor:4.11.0'
    implementation files('libs/android-async-http-1.4.5.jar')

    // Retrofit + RxJava
    implementation "com.squareup.retrofit2:retrofit:2.4.0"
    implementation "com.squareup.retrofit2:converter-gson:2.4.0"
    implementation "com.squareup.retrofit2:adapter-rxjava2:2.4.0"
    implementation "io.reactivex.rxjava2:rxjava:2.2.3"
    implementation "io.reactivex.rxjava2:rxandroid:2.1.0"

    // ========== 图片处理 ==========
    implementation 'com.github.bumptech.glide:glide:3.7.0'
    compileOnly 'com.github.bumptech.glide:glide:4.9.0'  // 依赖但不用打包
    implementation 'com.github.bumptech.glide:glide:4.12.0'
    implementation files('libs/universal-image-loader-1.9.0.jar')
    implementation 'com.makeramen:roundedimageview:2.3.0'  // 圆形图片
    implementation 'top.zibin:Luban:1.1.3'  // 图片压缩
    implementation 'cc.aoeiuv020:imaging:1.0'  // 图片编辑

    // ========== 音视频处理 ==========
    implementation('com.github.AoEiuV020:jjdxm_ijkplayer:1.1.1') {
        exclude group: 'com.android.support', module: 'appcompat-v7'
    }
    implementation 'com.github.ctiao:DanmakuFlameMaster:0.5.3'
    implementation 'tyrant:heartlayout:1.0.1'
    implementation 'org.jitsi.react:jitsi-meet-sdk:11.5.1'
    implementation 'com.danikula:videocache:2.7.1'  // 视频缓存
    implementation 'com.github.yangjie10930:EpMedia:v0.9.5'  // 视频处理
    implementation 'pl.droidsonroids.gif:android-gif-drawable:1.2.28'  // GIF
    implementation 'com.huangyz0918:androidwm-light:0.1.2'  // 图片水印

    // ========== 推送服务 ==========
    // 小米
    implementation files('libs/MiPush_SDK_Client_3_6_18.jar')
    // 华为
    implementation 'com.huawei.android.hms:push:2.5.2.300'
    implementation 'com.huawei.android.hms:base:2.5.2.300'
    // 魅族
    implementation 'com.meizu.flyme.internet:push-internal:3.8.1@aar'
    // vivo
    implementation files('libs/vivopushsdk_v2.3.4.jar')
    // oppo
    implementation files('libs/mcssdk-1.0.1.jar')
    // Firebase
    implementation 'com.google.firebase:firebase-core:16.0.9'
    implementation 'com.google.firebase:firebase-messaging:18.0.0'

    // ========== 第三方登录/支付 ==========
    // 支付宝
    implementation 'com.alipay.sdk:alipaysdk-android:15.8.11'
    // QQ登录
    implementation files('libs/open_sdk_r6199_lite.jar')
    // 微信
    implementation 'com.tencent.mm.opensdk:wechat-sdk-android-with-mta:1.0.2'

    // ========== UI组件 ==========
    implementation 'com.scwang.smartrefresh:SmartRefreshLayout:1.1.0-alpha-28'  // 下拉刷新
    implementation 'me.leolin:ShortcutBadger:1.1.22'  // 角标
    implementation 'com.hyman:flowlayout-lib:1.1.2'  // 流式布局
    implementation 'in.srain.cube:grid-view-with-header-footer:1.0.12'  // GridView
    implementation 'com.github.zcweng:switch-button:0.0.3@aar'  // 开关按钮
    implementation 'com.daimajia.numberprogressbar:library:1.4@aar'  // 进度条
    implementation 'com.github.ceryle:FitGridView:v1.0.5'  // 表格面板
    implementation 'me.imid.swipebacklayout.lib:library:1.1.0'  // 侧滑返回
    implementation 'com.leo618:zip:0.0.1'  // 快速SharedPreferences
    implementation 'com.joybar.calendar:librarycalendar:1.0.6'  // 日历
    implementation 'com.contrarywind:Android-PickerView:4.1.7'  // 选择器
    implementation 'com.github.xuexiangjys:XUI:1.2.1'  // UI框架
    implementation 'com.github.xuexiangjys:XUpdate:2.1.4'  // 更新框架

    // ========== 地图定位 ==========
    implementation files('libs/BaiduLBS_Android.jar')
    implementation 'com.google.android.gms:play-services-maps:16.1.0'
    implementation 'com.google.android.gms:play-services-location:16.0.0'

    // ========== 即时通讯 ==========
    var smackVersion = "4.4.6"
    implementation "org.igniterealtime.smack:smack-tcp:$smackVersion"
    implementation "org.igniterealtime.smack:smack-im:$smackVersion"
    implementation "org.igniterealtime.smack:smack-extensions:$smackVersion"
    implementation "org.igniterealtime.smack:smack-xmlparser-xpp3:$smackVersion"
    implementation "org.igniterealtime.smack:smack-experimental:$smackVersion"
    implementation "org.igniterealtime.smack:smack-android:$smackVersion"
    implementation "org.igniterealtime.smack:smack-sasl-provided:$smackVersion"
    implementation "org.igniterealtime.smack:smack-resolver-minidns:$smackVersion"

    // ========== 数据处理 ==========
    implementation 'org.greenrobot:eventbus:3.1.1'
    compileOnly files('libs/fastjson-1.2.40.jar')
    implementation 'com.belerweb:pinyin4j:2.5.0'  // 拼音
    implementation 'org.jsoup:jsoup:1.10.3'  // HTML解析
    implementation 'com.jakewharton.threetenabp:threetenabp:1.4.6'  // 时间处理

    // ========== 安全加密 ==========
    implementation 'org.bouncycastle:bcprov-jdk15on:1.57'
    implementation 'org.bouncycastle:bcprov-jdk15on:1.68'
    implementation 'org.bouncycastle:bcpkix-jdk15on:1.68'
    implementation 'io.jsonwebtoken:jjwt:0.9.1'  // JWT

    // ========== 文件操作 ==========
    implementation files('libs/httpmime-4.2.jar')
    compileOnly 'com.leo618:zip:0.0.1'

    // ========== 本地JAR/AAR文件 ==========
    implementation files('libs/all-20230425.jar')
    implementation files('../provider_lib/libs/JITLogSupport1.0.0.jar')
    implementation files('libs/nineoldandroids.jar')
    implementation files('libs/ormlite-android-4.48.jar')
    implementation files('libs/ormlite-core-4.48.jar')

    // ========== 测试相关 ==========
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'androidx.test.ext:junit:1.1.1'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'

    // ========== 其他工具库 ==========
    implementation 'com.tencent.bugly:crashreport:4.1.9'  // 崩溃上报
    implementation 'com.facebook.react:react-native:0.77.2'  //
//    implementation libs.react.native
    implementation 'androidx.work:work-runtime:2.7.1'  // 后台任务
    implementation "log4j:log4j:1.2.17"  // 日志
    implementation 'com.jeremyliao:fast-sharedpreferences:0.0.1'  // 快速存储
    implementation('com.github.chrisbanes.bitmapcache:library:2.3') {  // Bitmap缓存
        exclude group: 'com.google.android', module: 'support-v4'
    }

    // ========== 已注释的依赖（保留供参考） ==========
    /*
    //    implementation files('libs/simkeylibrary-release.aar')
    //    科达视频播放器
    //    implementation files('libs/kplayer-androidx-5.0.5-20240704-1.aar')
    //    implementation "com.kedacom.android:kplayer:5.0.5-20240704"
    //    implementation "com.kedacom:kplayer-androidx:5.0.5"
    //    支付宝旧版
    //    implementation files('libs/alipaySdk-15.5.9-20181123210601.aar')
    //    其他SDK
    //    implementation files('libs/xjgarsdklibrary-release-9.2.1-2019-08-31.aar')
    //    implementation 'libs/xjgarsdklibrary-release-9.2.1-2019-08-31.aar'
    //    备案读取
    //    implementation files('libs/libfriapkrecord-r1.0.1.aar')
    //    implementation 'local.omm-lib:simkeylibrary-release:1.0.0'
    //    implementation 'local.omm-lib:kplayer-androidx-5.0.5-20240704-1:1.0.0'
    //    implementation 'local.omm-lib:alipaySdk-15.5.9-20181123210601:1.0.0'
    //    implementation 'local.omm-lib:xjgarsdklibrary-release-9.2.1-2019-08-31:1.0.0'
    //    implementation 'local.omm-lib:libfriapkrecord-r1.0.1:1.0.0'
    //    implementation 'com.github.ForgetAll:LoadingDialog:v1.0.1'
    //    implementation files('libs/glide-3.7.0.jar')
    //    implementation "org.jitsi.react:jitsi-meet-sdk:9.2.2"
    */
}

configurations {
    all*.exclude group: 'xpp3', module: 'xpp3'
}

// 设置版本和组
//version = '1.0.0'
//group = 'com.oort'
//afterEvaluate {
//    publishing {
//        publications {
//            release(MavenPublication) {
//                from components.release  // ✅ 自动包含依赖信息
//
//                // 设置 Maven 坐标
//                groupId = group
//                artifactId = 'omm-lib'
//                version = version
//
//                // 可选：添加描述等信息
//                pom {
//                    description = 'OMM-SDK'
//                }
//            }
//        }
//    }
//}

// 定义扩展属性，便于管理
ext {
    PUBLISH_GROUP_ID = 'com.github.Bean-V'
    PUBLISH_ARTIFACT_ID = 'omm-sdk'  // 必须与GitHub仓库名一致！
    PUBLISH_VERSION = '1.0.0'
}

afterEvaluate {
    publishing {
        publications {
            release(MavenPublication) {
                from components.release

                // 使用定义的属性
                groupId = PUBLISH_GROUP_ID
                artifactId = PUBLISH_ARTIFACT_ID
                version = PUBLISH_VERSION

                pom {
                    name = PUBLISH_ARTIFACT_ID
                    description = 'OMM Android SDK'
                    url = "https://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}"

                    licenses {
                        license {
                            name = 'Apache License 2.0'
                            url = 'https://www.apache.org/licenses/LICENSE-2.0.txt'
                        }
                    }

                    developers {
                        developer {
                            id = 'Bean-V'
                            name = 'Bean V'
                            email = 'your-email@example.com'
                        }
                    }

                    scm {
                        connection = "scm:git:git://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}.git"
                        developerConnection = "scm:git:ssh://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}.git"
                        url = "https://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}"
                    }
                }
            }
        }
    }
}