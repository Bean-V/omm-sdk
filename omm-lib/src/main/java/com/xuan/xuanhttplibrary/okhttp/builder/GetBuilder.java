package com.xuan.xuanhttplibrary.okhttp.builder;import android.content.Context;import android.text.TextUtils;import android.util.Log;import com.oort.weichat.Reporter;import com.oort.weichat.util.log.LogUtils;import com.oortcloud.basemodule.constant.Constant;import com.xuan.xuanhttplibrary.okhttp.HttpUtils;import java.net.URLEncoder;import java.util.Arrays;import java.util.Collection;import java.util.Map;import java.util.Objects;import okhttp3.Request;/** * GET请求构建器，支持多类型参数（String/数字/布尔/数组等） */public class GetBuilder extends BaseBuilder {    /**     * 构造函数（注入依赖）     */    public GetBuilder(Context context, MacGenerator macGenerator, String appVersion) {        super(context, macGenerator, appVersion);    }    @Override    public GetBuilder url(String url) {        LogUtils.d("GetBuilder", url);        if (!TextUtils.isEmpty(url)) {            this.url = url;        }        return this;    }    @Override    public GetBuilder tag(Object tag) {        this.tag = tag;        return this;    }    @Override    public BaseCall abstractBuild() {        url = appenParams();        build = new Request.Builder()                .header("User-Agent", getUserAgent())                .addHeader("appid", Constant.APP_ID)                .addHeader("secretkey", Constant.SECRET_KEY)                .addHeader("requestType", "app")                .url(url)                .tag(tag)                .build();        Log.i(HttpUtils.TAG, "网络请求参数：" + url);        return new BaseCall(HttpUtils.getInstance().getOkHttpClient());    }    /**     * 构建URL（用于获取图形验证码等场景）     */    public String buildUrl() {        return buildUrl(true, true);    }    public String buildUrl(boolean mac, boolean beforeLogin) {        build(mac, beforeLogin);        return appenParams();    }    /**     * 拼接URL参数（支持多类型参数转换）     */    private String appenParams() {        if (TextUtils.isEmpty(url)) {            Log.e(HttpUtils.TAG, "URL为空，无法拼接参数");            return "";        }        StringBuffer sb = new StringBuffer(url);        if (!params.isEmpty()) {            sb.append(url.contains("?") ? "&" : "?");            // 修复：将Entry类型改为String, Object            for (Map.Entry<String, Object> entry : params.entrySet()) {                String key = entry.getKey();                // 将Object值转换为String后再编码                String valueStr = convertObjectToString(entry.getValue());                String encodedValue = encodeValue(valueStr);                sb.append(key).append("=").append(encodedValue).append("&");            }            // 移除最后一个多余的&            if (sb.charAt(sb.length() - 1) == '&') {                sb.deleteCharAt(sb.length() - 1);            }        }        return sb.toString();    }    /**     * URL编码（处理异常）     */    private String encodeValue(String value) {        if (TextUtils.isEmpty(value)) {            return "";        }        try {            return URLEncoder.encode(value, "UTF-8");        } catch (Exception e) {            Log.e(HttpUtils.TAG, "参数编码失败: " + value, e);            Reporter.unreachable(e);            return value;        }    }    // -------------------------- 核心优化：多类型参数支持 --------------------------    /**     * 原有String参数接口（兼容旧代码）     */    @Override    public GetBuilder params(String k, String v) {        if (!TextUtils.isEmpty(k)) {            params.put(k, v == null ? "" : v);        }        return this;    }    /**     * 新增：支持Object类型参数（自动转换为String）     * 支持类型：String/Integer/Long/Float/Double/Boolean/数组/Collection     */    public GetBuilder params(String key, Object value) {        if (TextUtils.isEmpty(key) || value == null) {            Log.w(HttpUtils.TAG, "忽略空参数（key为空或value为null）");            return this;        }        // 根据value类型转换为String        String valueStr = convertObjectToString(value);        params.put(key, valueStr);        return this;    }    /**     * 新增：支持Map<Object, Object>类型参数（自动转换所有value为String）     */    public GetBuilder params(Map<?, ?> paramsMap) {        if (paramsMap == null || paramsMap.isEmpty()) {            return this;        }        for (Map.Entry<?, ?> entry : paramsMap.entrySet()) {            String key = Objects.toString(entry.getKey(), ""); // key转为String            Object value = entry.getValue();            this.params(key, value); // 复用Object参数处理逻辑        }        return this;    }    /**     * 新增：支持数组类型参数（自动拼接为"key=v1&key=v2"格式）     */    public <T> GetBuilder params(String key, T[] array) {        if (TextUtils.isEmpty(key) || array == null || array.length == 0) {            return this;        }        // 遍历数组，添加多个同key的参数        for (T item : array) {            String itemStr = convertObjectToString(item);            params.put(key, itemStr);        }        return this;    }    /**     * 新增：支持Collection类型参数（如List/Set，自动拼接为"key=v1&key=v2"格式）     */    public <T> GetBuilder params(String key, Collection<T> collection) {        if (TextUtils.isEmpty(key) || collection == null || collection.isEmpty()) {            return this;        }        // 遍历集合，添加多个同key的参数        for (T item : collection) {            String itemStr = convertObjectToString(item);            params.put(key, itemStr);        }        return this;    }    /**     * 工具方法：将Object转换为String（支持常见类型）     */    private String convertObjectToString(Object value) {        if (value == null) {            return "";        }        // 1. 基本类型包装类（Integer/Long/Float/Double/Boolean）        if (value instanceof Integer || value instanceof Long ||                value instanceof Float || value instanceof Double ||                value instanceof Boolean) {            return value.toString();        }        // 2. 数组类型（如String[]/int[]，转为"v1,v2,v3"格式）        if (value.getClass().isArray()) {            if (value instanceof Object[]) {                return Arrays.toString((Object[]) value).replaceAll("[\\[\\] ]", "");            } else if (value instanceof int[]) {                return Arrays.toString((int[]) value).replaceAll("[\\[\\] ]", "");            } else if (value instanceof long[]) {                return Arrays.toString((long[]) value).replaceAll("[\\[\\] ]", "");            } else if (value instanceof float[]) {                return Arrays.toString((float[]) value).replaceAll("[\\[\\] ]", "");            } else if (value instanceof double[]) {                return Arrays.toString((double[]) value).replaceAll("[\\[\\] ]", "");            } else {                return value.toString(); // 其他数组类型默认处理            }        }        // 3. Collection类型（如List，转为"v1,v2,v3"格式）        if (value instanceof Collection) {            return ((Collection<?>) value).stream()                    .map(item -> Objects.toString(item, ""))                    .reduce((a, b) -> a + "," + b)                    .orElse("");        }        // 4. 其他类型（默认调用toString()）        return value.toString();    }}