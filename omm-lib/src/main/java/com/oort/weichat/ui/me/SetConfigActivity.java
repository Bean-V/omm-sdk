package com.oort.weichat.ui.me;import android.content.ComponentName;import android.content.Context;import android.content.Intent;import android.os.Bundle;import android.text.Editable;import android.text.TextUtils;import android.text.TextWatcher;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.AdapterView;import android.widget.LinearLayout;import android.widget.ListView;import android.widget.TextView;import com.alibaba.fastjson.JSONArray;import com.oortcloud.basemodule.utils.fastsharedpreferences.EnhancedEditor;import com.oortcloud.basemodule.utils.fastsharedpreferences.FastSharedPreferences;import com.oort.weichat.ui.base.BaseActivity;import com.oort.weichat.AppConfig;import com.oort.weichat.R;import com.oort.weichat.adapter.BaseListAdapter;import com.oort.weichat.broadcast.OtherBroadcast;import com.oort.weichat.db.SQLiteHelper;import com.oort.weichat.sp.UserSp;import com.oort.weichat.util.AppUtils;import com.oort.weichat.util.PreferenceUtils;import com.oort.weichat.util.ToastUtil;import com.oort.weichat.util.ViewPiexlUtil;import com.oort.weichat.view.ClearEditText;import com.oort.weichat.view.TipDialog;import com.oortcloud.basemodule.constant.Constant;import com.oortcloud.basemodule.constant.ConstantKey;import com.oortcloud.utils.SoftHideKeyBoardUtil;import java.util.ArrayList;import java.util.Arrays;import java.util.List;import java.util.Objects;import okhttp3.HttpUrl;/** * 配置服务器地址 */public class SetConfigActivity extends BaseActivity {    LayoutInflater mInflater;    TextView mTvSure;    ListView mListView;    private List<String> mdata;    private MyAdapter adapter;    ClearEditText mAddressIP;    ClearEditText mIPPort;    ClearEditText mIMPort;    ClearEditText mDownPort;    ClearEditText mUPPort;    ClearEditText mJitSiPort;    ClearEditText mLivePort;    ClearEditText mXMPPPort;    ClearEditText xm_pp_do_main;    ClearEditText api_key;    public SetConfigActivity() {        noLoginRequired();    }    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_setconfig);        initActionBar();        SoftHideKeyBoardUtil.assistActivity(this);        //  initResource();        mInflater = LayoutInflater.from(this);//        mAddressIP = (ClearEditText) findViewById(R.id.search_edit);        mListView = (ListView) findViewById(R.id.lv_setconfig);        mTvSure = (TextView) findViewById(R.id.tv_search_ok);        mAddressIP = (ClearEditText) findViewById(R.id.address_edit);        mIPPort = (ClearEditText) findViewById(R.id.ip_port);        mIMPort = (ClearEditText) findViewById(R.id.im_port);        mUPPort = (ClearEditText) findViewById(R.id.upload_port);        mDownPort = (ClearEditText) findViewById(R.id.down_port);        mJitSiPort = (ClearEditText) findViewById(R.id.jit_si_port);        mLivePort = (ClearEditText) findViewById(R.id.live_port);        mXMPPPort = (ClearEditText) findViewById(R.id.xmpp_port);        xm_pp_do_main = (ClearEditText) findViewById(R.id.xm_pp_do_main);        api_key = (ClearEditText) findViewById(R.id.api_key);        mTvSure.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                String input = mAddressIP.getText().toString().trim();                try {                    input = Objects.requireNonNull(HttpUrl.parse(input)).uri().normalize().toString();                    saveConfig(input);                } catch (Exception e) {                    Log.e(TAG, "onClick: 输入不合法 url = " + input, e);                    ToastUtil.showToast(mContext, getString(R.string.illegal_input));                }            }        });        mAddressIP.addTextChangedListener(new TextWatcher() {            @Override            public void onTextChanged(CharSequence s, int start, int before, int count) {            }            public void beforeTextChanged(CharSequence s, int start, int count, int after) {            }            @Override            public void afterTextChanged(Editable s) {                Log.e("xuan", "afterTextChanged: " + s.toString());                if (s.length() == 0) {                    mAddressIP.setText("http://");                }            }        });        String address = PreferenceUtils.getString(mContext, "APP_SERVICE_CONFIG");        if (TextUtils.isEmpty(address)) {            address = AppConfig.CONFIG_URL;        }        // 兼容服务器地址结尾多了一个/config的情况，        address = removeSuffix(address, "/config");        // 兼容服务器地址结尾多了一个斜杠/的情况，        address = removeSuffix(address, "/");        address = removeSuffix(address, "http://");        mAddressIP.setText(Constant.BASE_IP);        //获取配置过的信息        sharedConfig();        initDatas();    }    private String removeSuffix(final String s, final String suffix) {        if (s != null && suffix != null && s.endsWith(suffix)) {            return s.substring(0, s.length() - suffix.length());        }        return s;    }    private void initActionBar() {        getSupportActionBar().hide();        findViewById(R.id.iv_title_left).setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                finish();            }        });        TextView tvTitle = (TextView) findViewById(R.id.tv_title_center);        tvTitle.setText(R.string.change_server_address);        TextView tvRight = (TextView) findViewById(R.id.tv_title_right);        tvRight.setText(R.string.clean);        tvRight.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View v) {                cleanList();            }        });    }    private void saveConfig(final String str) {        boolean repeat = false;        for (String s : mdata) {            if (str.equals(s)) {                repeat = true;            }        }        if (!repeat) {            mdata.add(0, str);        }        saveList(mdata);        TipDialog tipDialog = new TipDialog(this);        tipDialog.setmConfirmOnClickListener(getString(R.string.tip_reboot_for_config), new TipDialog.ConfirmOnClickListener() {            @Override            public void confirm() {                AppConfig.saveConfigUrl(mContext, str);                setAddressIPAndPort();                UserSp.getInstance(mContext).clearUserInfo();                SQLiteHelper.rebuildDatabase(mContext);                //发送广播  重新拉起app                Intent intent = new Intent(OtherBroadcast.BROADCASTTEST_ACTION);                intent.setComponent(new ComponentName(AppConfig.sPackageName, AppConfig.myBroadcastReceiverClass));                sendBroadcast(intent);            }        });        tipDialog.show();    }    /**     * 获取设置ip端口信息     */    public void sharedConfig() {        FastSharedPreferences sharedPreferences = FastSharedPreferences.get(Constant.LOGIN_RESPONSE);        Constant.IF_CONFIG_APP_SERVICE = sharedPreferences.getBoolean(ConstantKey.IF_CONFIG_APP_SERVICE, false);        if (Constant.IF_CONFIG_APP_SERVICE) {            String addressIP = sharedPreferences.getString(ConstantKey.ADDRESS_IP_KEY, "");            if (!TextUtils.isEmpty(addressIP)) {                mAddressIP.setText(addressIP);            }            String ipPort = sharedPreferences.getString(ConstantKey.IP_PORT_KEY, "");            if (!TextUtils.isEmpty(ipPort)) {                mIPPort.setText(ipPort);            }            String imPort = sharedPreferences.getString(ConstantKey.IM_PORT_KEY, "");            if (!TextUtils.isEmpty(imPort)) {                mIMPort.setText(imPort);            }            String upPort = sharedPreferences.getString(ConstantKey.UPLOAD_PORT_KEY, "");            if (!TextUtils.isEmpty(upPort)) {                mUPPort.setText(upPort);            }            String downPort = sharedPreferences.getString(ConstantKey.DOWN_PORT_KEY, "");            if (!TextUtils.isEmpty(downPort)) {                mDownPort.setText(downPort);            }            String livePort = sharedPreferences.getString(ConstantKey.LIVE_PORT_KEY, "");            if (!TextUtils.isEmpty(livePort)) {                mLivePort.setText(livePort);            }            String xmppPort = sharedPreferences.getString(ConstantKey.XM_PP_PORT_KEY, "");            if (!TextUtils.isEmpty(xmppPort)) {                mXMPPPort.setText(xmppPort);            }            String xmppDomain = sharedPreferences.getString(ConstantKey.XM_PP_DO_MAIN_KEY, "");            if (!TextUtils.isEmpty(xmppDomain)) {                xm_pp_do_main.setText(xmppDomain);            }            String jitPort = sharedPreferences.getString(ConstantKey.JIT_SI_PORT_KEY, "");            if (!TextUtils.isEmpty(downPort)) {                mJitSiPort.setText(jitPort);            }            String apiKey = sharedPreferences.getString(ConstantKey.API_KEY, "");            if (!TextUtils.isEmpty(apiKey)) {                api_key.setText(apiKey);            }        }    }    /**     *  存储登录ip 和端口     */    private void setAddressIPAndPort(){        FastSharedPreferences sharedPreferences = FastSharedPreferences.get(Constant.LOGIN_RESPONSE);        EnhancedEditor editor = sharedPreferences.edit();        String addressIP =  mAddressIP.getText().toString().trim();        if (!TextUtils.isEmpty(addressIP)){            editor.putString(ConstantKey.ADDRESS_IP_KEY , addressIP).apply();            editor.putBoolean( ConstantKey.IF_CONFIG_APP_SERVICE , true).apply();        }        String ipPort =  mIPPort.getText().toString().trim();        if (!TextUtils.isEmpty(ipPort)){            editor.putString( ConstantKey.IP_PORT_KEY , ipPort).apply();        }        String imPort =  mIMPort.getText().toString().trim();        if (!TextUtils.isEmpty(imPort)){            editor.putString( ConstantKey.IM_PORT_KEY , imPort).apply();        }        String upPort =  mUPPort.getText().toString().trim();        if (!TextUtils.isEmpty(upPort)){            editor.putString(  ConstantKey.UPLOAD_PORT_KEY , upPort).apply();        }        String downPort =  mDownPort.getText().toString().trim();        if (!TextUtils.isEmpty(downPort)){            editor.putString( ConstantKey.DOWN_PORT_KEY , downPort).apply();        }        String videoPort =  mJitSiPort.getText().toString().trim();        if (!TextUtils.isEmpty(videoPort)){            editor.putString(  ConstantKey.JIT_SI_PORT_KEY , videoPort).apply();        }        String livePort =  mLivePort.getText().toString().trim();        if (!TextUtils.isEmpty(livePort)){            editor.putString( ConstantKey.LIVE_PORT_KEY , livePort).apply();        }        String xmppPort =  mXMPPPort.getText().toString().trim();        if (!TextUtils.isEmpty(xmppPort)){            editor.putString( ConstantKey.XM_PP_PORT_KEY , xmppPort).apply();        }        String xmppDomain =  xm_pp_do_main.getText().toString().trim();        if (!TextUtils.isEmpty(xmppDomain)){            editor.putString( ConstantKey.XM_PP_DO_MAIN_KEY , xmppDomain).apply();        }        String apiKey =  api_key.getText().toString().trim();        if (!TextUtils.isEmpty(apiKey)){            editor.putString( ConstantKey.API_KEY , apiKey).apply();        }    }    private List<String> getDefaultList() {        if (AppUtils.isApkDebug(mContext)) {            return new ArrayList<>(Arrays.asList(                    "http://192.168.0.128:8092",                    "http://192.168.0.141:8092",                    "http://192.168.0.142:8092",                    "http://192.168.0.168:8092"            ));        } else {            return new ArrayList<>();        }    }    private void initDatas() {        String str = PreferenceUtils.getString(this, "APP_LIST_CONFIG", null);        if (str == null) {            mdata = getDefaultList();        } else {            mdata = initList(str);        }        adapter = new MyAdapter(this);        // 绑定适配器        mListView.setAdapter(adapter);        adapter.setDatas(mdata);        mListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {            @Override            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {                mAddressIP.setText(mdata.get(position));            }        });    }    private void cleanList() {        mdata = getDefaultList();        adapter.setDatas(mdata);    }    private List<String> initList(String str) {        List<String> data = new ArrayList<>();        JSONArray js = JSONArray.parseArray(str);        for (int i = 0; i < js.size(); i++) {            String ss = js.getString(i);            data.add(ss);        }        return data;    }    private void saveList(List<String> data) {        if (data == null || data.size() == 0) {            return;        }        StringBuilder sb = new StringBuilder();        sb.append("[");        for (int i = 0; i < data.size(); i++) {            sb.append("\"");            sb.append(data.get(i));            sb.append("\"");            sb.append(",");        }        sb.deleteCharAt(sb.length() - 1);        sb.append("]");        Log.e("xuan", " " + sb.toString());        PreferenceUtils.putString(this, "APP_LIST_CONFIG", sb.toString());    }    class MyAdapter extends BaseListAdapter<String> {        MyAdapter(Context ctx) {            super(ctx);        }        @Override        public View getView(int position, View convertView, ViewGroup parent) {            ViewHolder holder;            if (convertView == null) {                convertView = mInflater.inflate(R.layout.item_server_address, parent, false);                holder = new ViewHolder();                holder.tvTitle = (TextView) convertView.findViewById(R.id.tv_item_number);                convertView.setTag(holder);            } else {                holder = (ViewHolder) convertView.getTag();            }            int height = ViewPiexlUtil.dp2px(SetConfigActivity.this, 40);            LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, height);/*            if (position == mdata.size() - 1) {                holder.tvTitle.setText(getString(R.string.default_place_holder, mdata.get(position)));            } else {                holder.tvTitle.setText(mdata.get(position));            }*/            holder.tvTitle.setText(mdata.get(position));            holder.tvTitle.setLayoutParams(params);            return convertView;        }    }    class ViewHolder {        TextView tvTitle;    }}