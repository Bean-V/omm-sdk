// ================================================
// omm-lib å‘å¸ƒé…ç½® - æ‰‹åŠ¨é…ç½®æ–¹å¼
// ================================================

ext {
    PUBLISH_GROUP_ID = 'com.github.Bean-V'
    PUBLISH_ARTIFACT_ID = 'omm-sdk'
    PUBLISH_VERSION = '2.0.5'
}

afterEvaluate {
    publishing {
        publications {
            release(MavenPublication) {
                // æ‰‹åŠ¨æ·»åŠ  AAR artifactï¼ˆä¸ä½¿ç”¨ from components.releaseï¼‰
                // ä½¿ç”¨ä»»åŠ¡è¾“å‡ºè€Œä¸æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®
                artifact(tasks.named("bundleReleaseAar").flatMap { it.archiveFile })
                
                groupId = PUBLISH_GROUP_ID
                artifactId = PUBLISH_ARTIFACT_ID
                version = PUBLISH_VERSION

                pom {
                    name = PUBLISH_ARTIFACT_ID
                    description = 'OMM Android SDK - Multi-module library with automatic dependency resolution'
                    url = "https://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}"

                    licenses {
                        license {
                            name = 'Apache License 2.0'
                            url = 'https://www.apache.org/licenses/LICENSE-2.0.txt'
                        }
                    }

                    developers {
                        developer {
                            id = 'Bean-V'
                            name = 'Bean V'
                            email = 'your-email@example.com'
                        }
                    }

                    scm {
                        connection = "scm:git:git://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}.git"
                        developerConnection = "scm:git:ssh://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}.git"
                        url = "https://github.com/Bean-V/${PUBLISH_ARTIFACT_ID}"
                    }
                    
                    withXml {
                        def dependenciesNode = asNode().appendNode('dependencies')
                        
                        // 1. æ·»åŠ æ‰€æœ‰å­æ¨¡å—ä¾èµ–
                        def subModules = [
                            'oort_imagepick_sdk', 'ToolsMain', 'provider_lib', 'pullToRefershLibraryMy',
                            'jcvideoplayer-lib', 'YZxing-lib', 'OpenGLlibrary', 'MPChartLib',
                            'liveLibrary', 'OortWebframeLib', 'basemodule', 'AppStore',
                            'Contacts', 'screenrecorder', 'AIDICert', 'sound_recon',
                            'FrameLibrary', 'Levc-lib', 'giraffeplayer', 'floatview', 'offline',
                            'matisse', 'Utilities3-1.0.3', 'ooortCloudDisk', 'IDCardCheck'  // âœ… æ·»åŠ ç¼ºå¤±çš„æ¨¡å—
                        ]
                        
                        println "\nğŸ“¦ [POM] æ·»åŠ å­æ¨¡å—ä¾èµ–..."
                        subModules.each { moduleName ->
                            def dependencyNode = dependenciesNode.appendNode('dependency')
                            dependencyNode.appendNode('groupId', PUBLISH_GROUP_ID)
                            dependencyNode.appendNode('artifactId', moduleName)
                            dependencyNode.appendNode('version', PUBLISH_VERSION)
                            dependencyNode.appendNode('scope', 'compile')
                        }
                        println "âœ… [POM] å·²æ·»åŠ  ${subModules.size()} ä¸ªå­æ¨¡å—ä¾èµ–"
                        
                        // 2. æ·»åŠ æ‰€æœ‰å¤–éƒ¨ä¾èµ–
                        println "\nğŸ“š [POM] æ·»åŠ å¤–éƒ¨ä¾èµ–..."
                        def addedCount = 0
                        def aarDependencies = [
                            'com.daimajia.numberprogressbar:library',
                            'com.github.zcweng:switch-button',
                            'com.meizu.flyme.internet:push-internal'
                        ] as Set
                        
                        // æ”¶é›†æ‰€æœ‰å·²æ·»åŠ çš„ä¾èµ–ï¼Œç”¨äºæ£€æŸ¥ç¼ºå¤±
                        def addedDeps = [] as Set
                        
                        configurations.implementation.allDependencies.each { dep ->
                            if (dep.group != null && dep.name != null && dep.version != null) {
                                if (!(dep instanceof org.gradle.api.artifacts.ProjectDependency)) {
                                    def depKey = "${dep.group}:${dep.name}"
                                    
                                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ  <type>aar</type>
                                    def needsAarType = (depKey == 'com.daimajia.numberprogressbar:library' || 
                                                       depKey == 'com.github.zcweng:switch-button' || 
                                                       depKey == 'com.meizu.flyme.internet:push-internal')
                                    
                                    def dependencyNode = dependenciesNode.appendNode('dependency')
                                    dependencyNode.appendNode('groupId', dep.group)
                                    dependencyNode.appendNode('artifactId', dep.name)
                                    dependencyNode.appendNode('version', dep.version)
                                    
                                    if (needsAarType) {
                                        dependencyNode.appendNode('type', 'aar')
                                        println "  ğŸ“¦ [AAR] ${depKey}:${dep.version} â†’ å·²æ·»åŠ  <type>aar</type>"
                                    }
                                    
                                    dependencyNode.appendNode('scope', 'compile')
                                    addedDeps.add(depKey)
                                    addedCount++
                                }
                            }
                        }
                        
                        println "âœ… [POM] å·²æ·»åŠ  ${addedCount} ä¸ªå¤–éƒ¨ä¾èµ–"
                    }
                }
            }
        }
    }
    
    tasks.withType(PublishToMavenRepository) {
        dependsOn 'bundleReleaseAar'
    }
    
    println "âœ… [omm-lib] å·²é…ç½® Maven å‘å¸ƒï¼ˆæ‰‹åŠ¨é…ç½®æ–¹å¼ï¼‰"
}
